<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generator Rencana Perbaikan Akreditasi</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel Compiler (to use JSX in the browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- XLSX Library (for Excel files) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDKs (Compat version for global access) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="react">
        // Helper components for SVG icons to replace lucide-react
        const Icon = ({ children, className = "w-6 h-6" }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const UploadCloud = ({ className }) => <Icon className={className}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242" /><path d="M12 12v9" /><path d="m16 16-4-4-4 4" /></Icon>;
        const FileText = ({ className, size }) => <Icon className={className || `w-${size || 5} h-${size || 5}`}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M10 9H8" /><path d="M16 13H8" /><path d="M16 17H8" /></Icon>;
        const BrainCircuit = ({ className }) => <Icon className={className}><path d="M12 2a4.5 4.5 0 0 0-4.5 4.5v.5a4.5 4.5 0 0 0-4.5 4.5v2a4.5 4.5 0 0 0 4.5 4.5h.5a4.5 4.5 0 0 0 4.5 4.5h2a4.5 4.5 0 0 0 4.5-4.5h.5a4.5 4.5 0 0 0 4.5-4.5v-2a4.5 4.5 0 0 0-4.5-4.5v-.5A4.5 4.5 0 0 0 12 2Z" /><path d="M3 13.5h2" /><path d="M19 13.5h2" /><path d="M12 18v2" /><path d="M12 4V2" /><path d="m4.5 9.5-.9-.9" /><path d="m19.5 9.5.9-.9" /><path d="m7.5 16.5-.9.9" /><path d="m16.5 16.5.9.9" /></Icon>;
        const LoaderCircle = ({ className }) => <Icon className={className + " animate-spin"}><path d="M21 12a9 9 0 1 1-6.219-8.56" /></Icon>;
        const AlertTriangle = ({ className }) => <Icon className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z" /><path d="M12 9v4" /><path d="M12 17h.01" /></Icon>;
        const ChevronRight = ({ className }) => <Icon className={className}><path d="m9 18 6-6-6-6" /></Icon>;
        const CheckCircle = ({ className }) => <Icon className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" /><path d="m9 11 3 3L22 4" /></Icon>;
        const ArrowRight = ({ className }) => <Icon className={className}><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></Icon>;
        const Download = ({ className }) => <Icon className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></Icon>;
        const Lightbulb = ({ className }) => <Icon className={className}><path d="M15 14c.2-1 .7-1.7 1.5-2.5C17.7 10.2 18 9 18 7c0-2.2-1.8-4-4-4S9.8 4.8 10 7c0 2 .3 3.2 1.5 4.5.8.8 1.3 1.5 1.5 2.5" /><path d="M9 18h6" /><path d="M10 22h4" /></Icon>;
        const Zap = ({ className }) => <Icon className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" /></Icon>;
        const XCircle = ({ className }) => <Icon className={className}><circle cx="12" cy="12" r="10" /><path d="m15 9-6 6" /><path d="m9 9 6 6" /></Icon>;
        const LockKeyhole = ({ className }) => <Icon className={className}><circle cx="12" cy="16" r="1" /><rect x="3" y="10" width="18" height="12" rx="2" /><path d="M7 10V7a5 5 0 0 1 10 0v3" /></Icon>;
        const Lock = ({ className }) => <Icon className={className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></Icon>;
        const Unlock = ({ className }) => <Icon className={className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 9.9-1" /></Icon>;
        
        const MessageModal = ({ message, type, onClose }) => {
            if (!message) return null;
            const bgColor = type === 'error' ? 'bg-red-800' : 'bg-blue-800';
            const textColor = type === 'error' ? 'text-red-100' : 'text-blue-100';
            const borderColor = type === 'error' ? 'border-red-700' : 'border-blue-700';
            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className={`rounded-lg shadow-xl p-6 border ${bgColor} ${borderColor} max-w-sm w-full mx-auto animate-fade-in`}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className={`text-lg font-bold ${textColor}`}>Pesan</h3>
                            <button onClick={onClose} className="text-white hover:text-gray-300"><XCircle className="w-6 h-6" /></button>
                        </div>
                        <p className={`text-sm ${textColor} mb-4 whitespace-pre-wrap`}>{message}</p>
                        <div className="text-right">
                            <button onClick={onClose} className="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-500 transition-colors duration-200">Tutup</button>
                        </div>
                    </div>
                </div>
            );
        };

        const useCustomDropzone = ({ onDrop, accept, disabled }) => {
            const { useState, useCallback, useRef } = React;
            const [isDragActive, setIsDragActive] = useState(false);
            const inputRef = useRef(null);

            const handleDragEnter = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                if (!disabled) setIsDragActive(true);
            }, [disabled]);

            const handleDragLeave = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragActive(false);
            }, []);

            const handleDragOver = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
            }, []);

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                setIsDragActive(false);
                if (!disabled) {
                    const files = Array.from(e.dataTransfer.files);
                    if (onDrop) onDrop(files);
                }
            }, [disabled, onDrop]);
            
            const openFileDialog = () => {
                if (inputRef.current) inputRef.current.click();
            };

            const handleInputChange = (e) => {
                const files = Array.from(e.target.files);
                if (onDrop) onDrop(files);
            };

            const getRootProps = () => ({
                onDragEnter: handleDragEnter,
                onDragLeave: handleDragLeave,
                onDragOver: handleDragOver,
                onDrop: handleDrop,
                onClick: openFileDialog,
            });

            const getInputProps = () => ({
                ref: inputRef,
                type: 'file',
                style: { display: 'none' },
                onChange: handleInputChange,
                accept: accept ? Object.values(accept).join(',') : null,
            });

            return { getRootProps, getInputProps, isDragActive };
        };


        function App() {
            const { useState, useCallback, useEffect } = React;

            const [isLocked, setIsLocked] = useState(true);
            const [passwordInput, setPasswordInput] = useState('');
            const [loginError, setLoginError] = useState('');
            const CORRECT_PASSWORD = 'mutu2025';
            const [apiKey, setApiKey] = useState('');
            const [isApiKeyInvalid, setIsApiKeyInvalid] = useState(false);
            const [rawData, setRawData] = useState(null);
            const [groupedData, setGroupedData] = useState(null);
            const [fileName, setFileName] = useState('');
            const [error, setError] = useState('');
            const [loadingStates, setLoadingStates] = useState({});
            const [isProcessingFile, setIsProcessingFile] = useState(false);
            const [downloadFormat, setDownloadFormat] = useState('xlsx');
            const [openStates, setOpenStates] = useState({});
            const [aiSummary, setAiSummary] = useState('');
            const [isSummaryLoading, setIsSummaryLoading] = useState(false);
            const [generationProgress, setGenerationProgress] = useState({ current: 0, total: 0, message: '' });
            const [documentInventory, setDocumentInventory] = useState(null);
            const [groupedDocumentsByTypeForDisplay, setGroupedDocumentsByTypeForDisplay] = useState(null);
            const [showDocumentInventory, setShowDocumentInventory] = useState(false);
            const [showDocumentGrouping, setShowDocumentGrouping] = useState(false);
            const [modalMessage, setModalMessage] = useState({ message: '', type: '' });
            const [batchResult, setBatchResult] = useState(null);
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            
            const handlePasswordSubmit = (e) => {
                e.preventDefault();
                if (passwordInput === CORRECT_PASSWORD) {
                    setIsLocked(false);
                    setLoginError('');
                    setPasswordInput('');
                } else {
                    setLoginError('Kata sandi salah. Silakan coba lagi.');
                    setPasswordInput('');
                }
            };

            const handleLockApp = () => setIsLocked(true);

            useEffect(() => {
                try {
                    const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                    const firebaseConfig = JSON.parse(firebaseConfigStr);
                    
                    if (!firebase.apps.length && Object.keys(firebaseConfig).length > 0) {
                        firebase.initializeApp(firebaseConfig);
                    }
                    
                    const firestoreDb = firebase.firestore();
                    const auth = firebase.auth();
                    setDb(firestoreDb);

                    const unsubscribe = auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            setUserId(user.uid);
                        } else {
                            try {
                                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                                if (initialAuthToken) {
                                    await auth.signInWithCustomToken(initialAuthToken);
                                } else {
                                    await auth.signInAnonymously();
                                }
                            } catch (authError) {
                                console.error("Kesalahan Otentikasi Firebase:", authError);
                            }
                        }
                        setIsAuthReady(true);
                    });

                    return () => unsubscribe();
                } catch (e) {
                    console.error("Kesalahan saat menginisialisasi Firebase:", e);
                    setIsAuthReady(true);
                }
            }, []);

            const saveToFirestore = useCallback(async (dataToSave, currentFileName, currentUserId, currentAiSummary) => {
                if (!db || !currentUserId || !currentFileName) return;
                if (Object.keys(dataToSave).length === 0 && !currentAiSummary) return;
                
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const docRef = db.doc(`artifacts/${appId}/users/${currentUserId}/pps_data/${currentFileName}`);
                
                try {
                    await docRef.set({
                        groupedData: dataToSave,
                        aiSummary: currentAiSummary,
                        timestamp: new Date(),
                    }, { merge: true });
                } catch (e) {
                    console.error("Kesalahan saat menyimpan ke Firestore:", e);
                }
            }, [db]);

            useEffect(() => {
                if (isAuthReady && userId && fileName && groupedData) {
                    const handler = setTimeout(() => {
                        saveToFirestore(groupedData, fileName, userId, aiSummary);
                    }, 1500);
                    return () => clearTimeout(handler);
                }
            }, [groupedData, aiSummary, userId, fileName, isAuthReady, saveToFirestore]);
            
            const toggleOpen = (id) => setOpenStates(prev => ({ ...prev, [id]: !prev[id] }));

            const processData = (data) => {
                const groups = {};
                data.forEach((row, index) => {
                    const cleanedRow = Object.keys(row).reduce((acc, key) => {
                        acc[key.trim().toLowerCase().replace(/\s+/g, '')] = row[key];
                        return acc;
                    }, {});
                    const codeKey = Object.keys(cleanedRow).find(k => k.includes('babstandarkriteriaelemenpenilaian') || k.includes('kodeep') || k.includes('kode'));
                    if (!codeKey || !cleanedRow[codeKey]) return;
                    const code = String(cleanedRow[codeKey]);
                    const parts = code.split('.');
                    if (parts.length < 4) return;
                    const [bab, standar, kriteria, ...epParts] = parts;
                    const ep = epParts.join('.');
                    if (!groups[bab]) groups[bab] = { title: `BAB ${bab}`, standards: {} };
                    if (!groups[bab].standards[standar]) groups[bab].standards[standar] = { title: `Standar ${standar}`, criterias: {} };
                    if (!groups[bab].standards[standar].criterias[kriteria]) {
                        groups[bab].standards[standar].criterias[kriteria] = { title: `Kriteria ${kriteria}`, items: [] };
                    }
                    const itemData = {
                        id: `${code}-${index}`,
                        kode_ep: code,
                        uraian_ep: cleanedRow['uraianelemenpenilaian'] || '',
                        rekomendasi_survey: cleanedRow['rekomendasihasilsurvey'] || '',
                        rencana_perbaikan: cleanedRow['rencanaperbaikan'] || '',
                        indikator: cleanedRow['indikatorpencapaian'] || cleanedRow['indikator'] || '',
                        sasaran: cleanedRow['sasaran'] || '',
                        waktu: cleanedRow['waktupenyelesaian'] || cleanedRow['waktu'] || '',
                        pj: cleanedRow['penanggungjawab'] || cleanedRow['pj'] || '',
                        keterangan: "Klik 'Buat Keterangan'",
                    };
                    groups[bab].standards[standar].criterias[kriteria].items.push(itemData);
                });
                return groups;
            };

            const onDrop = useCallback(async (acceptedFiles) => {
                setError(''); setRawData(null); setGroupedData(null); setFileName(''); setAiSummary(''); setDocumentInventory(null); setGroupedDocumentsByTypeForDisplay(null); setShowDocumentInventory(false); setShowDocumentGrouping(false); setModalMessage({ message: '', type: '' }); setBatchResult(null);
                setIsProcessingFile(true);
                const file = acceptedFiles[0];
                if (!file) {
                    setModalMessage({ message: "File tidak valid.", type: 'error' });
                    setIsProcessingFile(false);
                    return;
                }
                setFileName(file.name);
                try {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const workbook = XLSX.read(event.target.result, { type: 'binary' });
                            const sheetName = workbook.SheetNames[0];
                            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { defval: "" });
                            if (jsonData.length === 0) {
                                setModalMessage({ message: "File Excel kosong atau formatnya tidak bisa dibaca.", type: 'error' });
                                setRawData(null);
                                return;
                            }
                            const processedData = processData(jsonData);
                            setRawData(jsonData);
                            setGroupedData(processedData);
                        } catch (e) {
                            setModalMessage({ message: "Terjadi kesalahan saat memproses file Excel. Pastikan format file benar.", type: 'error' });
                            console.error("Kesalahan pemprosesan file:", e);
                        } finally {
                            setIsProcessingFile(false);
                        }
                    };
                    reader.onerror = () => {
                        setModalMessage({ message: "Gagal membaca file.", type: 'error' });
                        setIsProcessingFile(false);
                    };
                    reader.readAsBinaryString(file);
                } catch (err) {
                    setModalMessage({ message: err.message, type: 'error' });
                    setIsProcessingFile(false);
                }
            }, []);
            
            const { getRootProps, getInputProps, isDragActive } = useCustomDropzone({ onDrop, accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'], 'text/csv': ['.csv'] }, disabled: isProcessingFile });

            const updateItemState = useCallback((itemId, field, value) => {
                setGroupedData(prevGroupedData => {
                    if (!prevGroupedData) return prevGroupedData;
                    const newGroupedData = JSON.parse(JSON.stringify(prevGroupedData));
                    for (const babKey in newGroupedData) {
                        for (const stdKey in newGroupedData[babKey].standards) {
                            for (const kriKey in newGroupedData[babKey].standards[stdKey].criterias) {
                                const criteria = newGroupedData[babKey].standards[stdKey].criterias[kriKey];
                                const itemIndex = criteria.items.findIndex(i => i.id === itemId);
                                if (itemIndex > -1) {
                                    criteria.items[itemIndex][field] = value;
                                    return newGroupedData;
                                }
                            }
                        }
                    }
                    return prevGroupedData;
                });
            }, []);

            const callAiApi = async (prompt) => {
                if (!apiKey) {
                    setIsApiKeyInvalid(true);
                    throw new Error("API_KEY_MISSING");
                }
                setIsApiKeyInvalid(false);
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                let response;
                try {
                    response = await fetch(apiUrl, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                } catch (networkError) {
                    console.error("Kesalahan Jaringan selama fetch:", networkError);
                    throw new Error("NETWORK_ERROR");
                }
                const responseText = await response.text();
                if (!response.ok) {
                    let errorMsg = `Kesalahan HTTP! status: ${response.status}`;
                    if (responseText) {
                        try {
                            const errorBody = JSON.parse(responseText);
                            if (response.status === 400 && errorBody?.error?.message.toLowerCase().includes("api key not valid")) {
                                setIsApiKeyInvalid(true);
                                throw new Error("API_KEY_INVALID");
                            }
                            errorMsg += ` - ${errorBody?.error?.message || 'Tidak dikenal.'}`;
                        } catch (e) { errorMsg += ` - Respons error tidak dapat dibaca.`; }
                    }
                    throw new Error(errorMsg);
                }
                if (!responseText) throw new Error("EMPTY_RESPONSE");
                let result;
                try { result = JSON.parse(responseText); } catch (e) { throw new Error("INVALID_JSON"); }
                if (!result.candidates || result.candidates.length === 0) {
                    if (result.promptFeedback && result.promptFeedback.blockReason) throw new Error(`PROMPT_BLOCKED: ${result.promptFeedback.blockReason}`);
                    throw new Error("NO_CANDIDATES");
                }
                if (result.candidates[0].finishReason === 'SAFETY') throw new Error("RESPONSE_BLOCKED_SAFETY");
                if (result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text.trim().replace(/^"|"$/g, '');
                }
                return "Respons AI tidak valid atau kosong.";
            };
            
            const handleApiError = (e) => {
                let message = `Gagal menghubungi AI: ${e.message}`;
                if (e.message === "API_KEY_MISSING") message = "Harap masukkan Kunci API Google AI Anda terlebih dahulu.";
                else if (e.message === "API_KEY_INVALID") message = "Kunci API tidak valid. Harap periksa kembali dan coba lagi.";
                else if (e.message === "NETWORK_ERROR") message = "Gagal terhubung ke server AI. Periksa koneksi internet Anda.";
                else if (e.message === "EMPTY_RESPONSE" || e.message.startsWith("PROMPT_BLOCKED") || e.message === "RESPONSE_BLOCKED_SAFETY" || e.message === "NO_CANDIDATES") message = "Respons dari AI diblokir, kemungkinan karena filter keamanan. Coba ubah input Anda.";
                
                setModalMessage({ message, type: 'error' });
                console.error("Kesalahan API yang ditangani:", e);
            };

            const cleanAiInput = (text) => {
                if (typeof text !== 'string' || !text) return '';
                const cleaned = text.trim();
                if (cleaned.includes('Klik \'Buat Keterangan\'') || cleaned.includes('Gagal diproses')) return '';
                return cleaned;
            };

            const handleGenerateKeterangan = async (item) => {
                const cleanedRencanaPerbaikan = cleanAiInput(item.rencana_perbaikan);
                const cleanedIndikator = cleanAiInput(item.indikator);
                const cleanedSasaran = cleanAiInput(item.sasaran);
                if (!cleanedRencanaPerbaikan && !cleanedIndikator && !cleanedSasaran) {
                    updateItemState(item.id, 'keterangan', 'Input data tidak siap (isi RTL/Indikator/Sasaran)');
                    return;
                }
                setLoadingStates(prev => ({ ...prev, [item.id + '_ket']: true }));
                const prompt = `PERAN: Anda adalah auditor akreditasi. TUGAS: Buatkan satu judul DOKUMEN BUKTI IMPLEMENTASI yang konkret berdasarkan data berikut. DATA: - Rencana Perbaikan: "${cleanedRencanaPerbaikan}" - Indikator: "${cleanedIndikator}" - Sasaran: "${cleanedSasaran}". ATURAN: Jawaban harus berupa satu frasa/kalimat tunggal, spesifik, dan dalam format nama dokumen resmi.`;
                try {
                    const generatedText = await callAiApi(prompt);
                    updateItemState(item.id, 'keterangan', generatedText);
                } catch (e) {
                    handleApiError(e);
                    updateItemState(item.id, 'keterangan', `Gagal: ${e.message}`);
                } finally {
                    setLoadingStates(prev => ({ ...prev, [item.id + '_ket']: false }));
                }
            };
            
            const handleGenerateRTL = async (item) => {
                const cleanedUraianEp = cleanAiInput(item.uraian_ep);
                const cleanedRekomendasiSurvey = cleanAiInput(item.rekomendasi_survey);
                if (!cleanedUraianEp && !cleanedRekomendasiSurvey) {
                    updateItemState(item.id, 'rencana_perbaikan', 'Data tidak cukup untuk ide RTL');
                    return;
                }
                setLoadingStates(prev => ({ ...prev, [item.id + '_rtl']: true }));
                const prompt = `PERAN: Anda adalah konsultan mutu. TUGAS: Buatkan satu kalimat RENCANA PERBAIKAN (RTL) yang operasional dan terukur. DATA: - Uraian Elemen Penilaian: "${cleanedUraianEp}" - Rekomendasi Awal: "${cleanedRekomendasiSurvey}". ATURAN: Jawaban harus berupa kalimat tindakan yang jelas.`;
                try {
                    const generatedText = await callAiApi(prompt);
                    updateItemState(item.id, 'rencana_perbaikan', generatedText);
                } catch (e) {
                    handleApiError(e);
                    updateItemState(item.id, 'rencana_perbaikan', `Gagal: ${e.message}`);
                } finally {
                    setLoadingStates(prev => ({ ...prev, [item.id + '_rtl']: false }));
                }
            };

            const handleGenerateIndikator = async (item) => {
                const cleanedUraianEp = cleanAiInput(item.uraian_ep);
                const cleanedRencanaPerbaikan = cleanAiInput(item.rencana_perbaikan);
                if (!cleanedUraianEp && !cleanedRencanaPerbaikan) {
                    updateItemState(item.id, 'indikator', 'Data tidak cukup untuk indikator');
                    return;
                }
                setLoadingStates(prev => ({ ...prev, [item.id + '_indikator']: true }));
                const prompt = `PERAN: Anda adalah seorang perencana mutu. TUGAS: Buatkan satu poin indikator pencapaian yang spesifik dan terukur. DATA: - Uraian Elemen Penilaian: "${cleanedUraianEp}" - Rencana Perbaikan: "${cleanedRencanaPerbaikan}". ATURAN: Jawaban harus berupa frasa indikator yang jelas.`;
                try {
                    const generatedText = await callAiApi(prompt);
                    updateItemState(item.id, 'indikator', generatedText);
                } catch (e) {
                    handleApiError(e);
                    updateItemState(item.id, 'indikator', `Gagal: ${e.message}`);
                } finally {
                    setLoadingStates(prev => ({ ...prev, [item.id + '_indikator']: false }));
                }
            };

            const handleGenerateSasaran = async (item) => {
                const cleanedUraianEp = cleanAiInput(item.uraian_ep);
                const cleanedRencanaPerbaikan = cleanAiInput(item.rencana_perbaikan);
                if (!cleanedUraianEp && !cleanedRencanaPerbaikan) {
                    updateItemState(item.id, 'sasaran', 'Data tidak cukup untuk sasaran');
                    return;
                }
                setLoadingStates(prev => ({ ...prev, [item.id + '_sasaran']: true }));
                const prompt = `PERAN: Anda adalah seorang manajer strategi. TUGAS: Buatkan satu poin sasaran yang jelas dan berorientasi hasil. DATA: - Uraian Elemen Penilaian: "${cleanedUraianEp}" - Rencana Perbaikan: "${cleanedRencanaPerbaikan}". ATURAN: Jawaban harus berupa kalimat sasaran yang ringkas.`;
                try {
                    const generatedText = await callAiApi(prompt);
                    updateItemState(item.id, 'sasaran', generatedText);
                } catch (e) {
                    handleApiError(e);
                    updateItemState(item.id, 'sasaran', `Gagal: ${e.message}`);
                } finally {
                    setLoadingStates(prev => ({ ...prev, [item.id + '_sasaran']: false }));
                }
            };

            return (
                <div className="bg-slate-900 min-h-screen text-white font-sans p-4 sm:p-6 lg:p-8">
                    {isLocked && (
                        <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
                            <form onSubmit={handlePasswordSubmit} className="w-full max-w-sm bg-slate-800 rounded-xl shadow-2xl p-8 border border-slate-700 text-center animate-fade-in">
                                <LockKeyhole className="w-16 h-16 text-cyan-400 mx-auto mb-4" />
                                <h2 className="text-2xl font-bold text-white mb-2">Aplikasi Terkunci</h2>
                                <p className="text-slate-400 mb-6">Silakan masukkan kata sandi untuk melanjutkan.</p>
                                <input type="password" value={passwordInput} onChange={(e) => setPasswordInput(e.target.value)} placeholder="Kata Sandi" className={`w-full bg-slate-700 border rounded-md px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 text-center ${loginError ? 'border-red-500 focus:ring-red-500' : 'border-slate-600 focus:ring-cyan-500'}`} />
                                {loginError && <p className="text-red-400 text-sm mt-3 flex items-center justify-center gap-2"><AlertTriangle className="w-4 h-4" />{loginError}</p>}
                                <button type="submit" className="w-full mt-6 inline-flex items-center justify-center gap-2 px-6 py-3 bg-cyan-600 text-white font-semibold rounded-md hover:bg-cyan-500 transition-all duration-200"><Unlock className="w-5 h-5" /><span>Buka</span></button>
                            </form>
                        </div>
                    )}
                    <MessageModal message={modalMessage.message} type={modalMessage.type} onClose={() => setModalMessage({ message: '', type: '' })} />
                    
                    <div className="max-w-7xl mx-auto">
                        <header className="text-center mb-8 flex justify-between items-center">
                            <div className="text-left">
                                <h1 className="text-3xl sm:text-4xl font-bold text-cyan-400">Rencana Perbaikan Akreditasi Berbasis AI</h1>
                                <p className="text-slate-400 mt-2">Unggah file, AI akan membantu, lalu unduh hasilnya.</p>
                            </div>
                            <button onClick={handleLockApp} className="flex-shrink-0 ml-4 inline-flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-500" title="Kunci Aplikasi">
                                <Lock className="w-5 h-5" /><span className="hidden sm:inline">Kunci</span>
                            </button>
                        </header>

                        <div className="bg-slate-800 rounded-xl p-6 mb-8 shadow-lg">
                            <label htmlFor="apiKey" className="block text-sm font-medium text-slate-300 mb-2">Kunci API Google AI</label>
                            <input id="apiKey" type="password" value={apiKey} onChange={(e) => { setApiKey(e.target.value); setIsApiKeyInvalid(false); }} placeholder="Masukkan Kunci API Anda di sini..." className={`w-full bg-slate-700 border rounded-md px-3 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 ${isApiKeyInvalid ? 'border-red-500 focus:ring-red-500' : 'border-slate-600 focus:ring-cyan-500'}`} />
                            {isApiKeyInvalid && <p className="text-sm text-red-400 mt-2 flex items-center"><AlertTriangle className="w-4 h-4 mr-1"/> Kunci API tidak valid atau belum dimasukkan.</p>}
                            <div className="mt-4">
                                <button onClick={() => setOpenStates(prev => ({...prev, isHelpOpen: !prev.isHelpOpen}))} className="text-sm font-medium text-cyan-400 cursor-pointer hover:text-cyan-300 list-none flex items-center gap-1">
                                    Bagaimana cara mendapatkan Kunci API?
                                    <ChevronRight className={`w-4 h-4 transition-transform duration-200 ${openStates.isHelpOpen ? 'rotate-90' : ''}`} />
                                </button>
                                {openStates.isHelpOpen && (
                                    <div className="mt-2 text-sm text-slate-400 bg-slate-900/50 p-4 rounded-md border border-slate-700">
                                        <ol className="list-decimal list-inside space-y-2">
                                            <li>Buka situs <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-teal-400 hover:underline">Google AI Studio</a>.</li>
                                            <li>Masuk dengan akun Google Anda.</li>
                                            <li>Klik tombol <span className="font-semibold text-slate-300">"Buat kunci API"</span>.</li>
                                            <li>Salin (copy) kunci API yang baru dibuat.</li>
                                            <li>Tempel (paste) kunci API tersebut ke kolom di atas.</li>
                                        </ol>
                                    </div>
                                )}
                            </div>
                        </div>

                        {!groupedData && (
                            <div className="flex flex-col items-center justify-center gap-4">
                                <div {...getRootProps()} className={`w-full p-10 border-2 border-dashed rounded-xl transition-all duration-300 ${isProcessingFile ? 'cursor-wait bg-slate-800' : 'cursor-pointer hover:border-cyan-500 hover:bg-slate-800'} ${isDragActive ? 'border-cyan-400 bg-slate-700' : 'border-slate-600'}`}>
                                    <input {...getInputProps()} />
                                    <div className="flex flex-col items-center justify-center text-center">
                                        {isProcessingFile ? (
                                            <><LoaderCircle className="w-12 h-12 text-cyan-500 mb-4" /><p>Memproses file...</p></>
                                        ) : (
                                            <><UploadCloud className="w-12 h-12 text-slate-500 mb-4" />{isDragActive ? <p>Lepaskan file...</p> : <><p>Seret & lepas file .xlsx di sini</p><p className="text-sm text-slate-400 mt-1">atau klik untuk memilih file</p></>}</>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {groupedData && (
                            <div className="animate-fade-in">
                                {Object.values(groupedData).map(bab => (
                                    <div key={bab.title} className="bg-slate-800 rounded-lg shadow-md overflow-hidden mb-2">
                                        <div onClick={() => toggleOpen(bab.title)} className="flex justify-between items-center bg-slate-700/50 px-6 py-3 cursor-pointer hover:bg-slate-700">
                                            <h2 className="text-xl font-bold text-cyan-400">{bab.title}</h2>
                                            <ChevronRight className={`w-6 h-6 text-cyan-400 transition-transform duration-300 ${openStates[bab.title] ? 'rotate-90' : ''}`} />
                                        </div>
                                        {openStates[bab.title] && (
                                            <div className="p-4 space-y-3">
                                                {Object.values(bab.standards).map(standard => {
                                                    const standardId = `${bab.title}-${standard.title}`;
                                                    return (
                                                        <div key={standardId} className="bg-slate-900/70 rounded-md">
                                                            <div onClick={() => toggleOpen(standardId)} className="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-slate-800/80 border-b border-slate-700">
                                                                <h3 className="text-lg font-semibold text-teal-300">{standard.title}</h3>
                                                                <ChevronRight className={`w-5 h-5 text-teal-300 transition-transform duration-300 ${openStates[standardId] ? 'rotate-90' : ''}`} />
                                                            </div>
                                                            {openStates[standardId] && (
                                                                <div className="p-3 space-y-2">
                                                                    {Object.values(standard.criterias).map(criteria => {
                                                                        const criteriaId = `${standardId}-${criteria.title}`;
                                                                        return (
                                                                            <div key={criteriaId} className="bg-slate-800/60 rounded">
                                                                                <div onClick={() => toggleOpen(criteriaId)} className="flex justify-between items-center px-4 py-2 cursor-pointer hover:bg-slate-700/70 border-b border-slate-700/50">
                                                                                    <h4 className="font-semibold text-amber-300">{criteria.title}</h4>
                                                                                    <ChevronRight className={`w-5 h-5 text-amber-300 transition-transform duration-300 ${openStates[criteriaId] ? 'rotate-90' : ''}`} />
                                                                                </div>
                                                                                {openStates[criteriaId] && (
                                                                                    <div className="p-4 space-y-4">
                                                                                        {criteria.items.map(item => (
                                                                                            <div key={item.id} className="bg-slate-700/50 p-4 rounded-lg border border-slate-600">
                                                                                                <p className="font-bold text-cyan-500 mb-2">{item.kode_ep}</p>
                                                                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-y-3 gap-x-6 text-sm">
                                                                                                    <div className="flex items-start gap-2">
                                                                                                        <strong className="text-slate-400 whitespace-nowrap">Rencana Perbaikan:</strong> 
                                                                                                        <div className="flex-grow"><p>{item.rencana_perbaikan}</p><button onClick={() => handleGenerateRTL(item)} disabled={loadingStates[item.id + '_rtl'] || !apiKey || isApiKeyInvalid} className="mt-1 flex items-center gap-1 text-xs text-yellow-400 hover:text-yellow-300 disabled:text-slate-500 disabled:cursor-not-allowed">{loadingStates[item.id + '_rtl'] ? <><LoaderCircle className="w-3 h-3 animate-spin"/> Memproses...</> : <><Lightbulb className="w-3 h-3"/> Buat/Perbaiki dengan AI</>}</button></div>
                                                                                                    </div>
                                                                                                    <div className="flex items-start gap-2">
                                                                                                        <strong className="text-slate-400 whitespace-nowrap">Indikator:</strong> 
                                                                                                        <div className="flex-grow"><p>{item.indikator}</p><button onClick={() => handleGenerateIndikator(item)} disabled={loadingStates[item.id + '_indikator'] || !apiKey || isApiKeyInvalid} className="mt-1 flex items-center gap-1 text-xs text-green-400 hover:text-green-300 disabled:text-slate-500 disabled:cursor-not-allowed">{loadingStates[item.id + '_indikator'] ? <><LoaderCircle className="w-3 h-3 animate-spin"/> Memproses...</> : <><Lightbulb className="w-3 h-3"/> Buat/Perbaiki dengan AI</>}</button></div>
                                                                                                    </div>
                                                                                                    <div className="flex items-start gap-2">
                                                                                                        <strong className="text-slate-400 whitespace-nowrap">Sasaran:</strong> 
                                                                                                        <div className="flex-grow"><p>{item.sasaran}</p><button onClick={() => handleGenerateSasaran(item)} disabled={loadingStates[item.id + '_sasaran'] || !apiKey || isApiKeyInvalid} className="mt-1 flex items-center gap-1 text-xs text-blue-400 hover:text-blue-300 disabled:text-slate-500 disabled:cursor-not-allowed">{loadingStates[item.id + '_sasaran'] ? <><LoaderCircle className="w-3 h-3 animate-spin"/> Memproses...</> : <><Lightbulb className="w-3 h-3"/> Buat/Perbaiki dengan AI</>}</button></div>
                                                                                                    </div>
                                                                                                    <div><strong className="text-slate-400">Waktu:</strong> {item.waktu}</div>
                                                                                                    <div><strong className="text-slate-400">PJ:</strong> {item.pj}</div>
                                                                                                </div>
                                                                                                <div className="mt-4 pt-4 border-t border-slate-600">
                                                                                                    <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                                                                                        <div><strong className="text-slate-300 flex items-center gap-2 mb-1"><FileText size={16} /> Keterangan / Bukti Implementasi:</strong><p className="text-cyan-300 pl-2">{item.keterangan}</p></div>
                                                                                                        <button onClick={() => handleGenerateKeterangan(item)} disabled={loadingStates[item.id + '_ket'] || !apiKey || isApiKeyInvalid} className="flex-shrink-0 flex items-center justify-center gap-2 px-4 py-2 bg-cyan-600 text-white font-semibold rounded-md hover:bg-cyan-500 disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors duration-200">
                                                                                                            {loadingStates[item.id + '_ket'] ? <LoaderCircle className="animate-spin w-5 h-5" /> : <BrainCircuit className="w-5 h-5" />}
                                                                                                            <span>{loadingStates[item.id + '_ket'] ? 'Memproses...' : 'Buat Keterangan'}</span>
                                                                                                        </button>
                                                                                                    </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        ))}
                                                                                    </div>
                                                                                )}
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
