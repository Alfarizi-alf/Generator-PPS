import React, { useState, useCallback, useEffect } from 'react';
import { useDropzone } from 'react-dropzone';
// We will load XLSX library dynamically from a CDN.
import { UploadCloud, FileText, BrainCircuit, LoaderCircle, AlertTriangle, ChevronRight, CheckCircle, ArrowRight, Download, Lightbulb, Zap, XCircle, LockKeyhole, Lock, Unlock } from 'lucide-react';

// Import Firebase modules
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, where, addDoc, getDocs, updateDoc } from 'firebase/firestore';


// Helper function to dynamically load the XLSX script from a CDN
const loadXlsxScript = () => {
  return new Promise((resolve, reject) => {
    if (window.XLSX) return resolve();
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
    script.onload = () => resolve();
    script.onerror = () => reject(new Error('Gagal memuat pustaka Excel. Periksa koneksi internet Anda.'));
    document.head.appendChild(script);
  });
};

// Custom Alert/Message Modal Component (Replaces window.alert)
const MessageModal = ({ message, type, onClose }) => {
  if (!message) return null;

  const bgColor = type === 'error' ? 'bg-red-800' : 'bg-blue-800';
  const textColor = type === 'error' ? 'text-red-100' : 'text-blue-100';
  const borderColor = type === 'error' ? 'border-red-700' : 'border-blue-700';

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className={`rounded-lg shadow-xl p-6 border ${bgColor} ${borderColor} max-w-sm w-full mx-auto animate-fade-in`}>
        <div className="flex justify-between items-center mb-4">
          <h3 className={`text-lg font-bold ${textColor}`}>Pesan</h3>
          <button onClick={onClose} className="text-white hover:text-gray-300">
            <XCircle className="w-6 h-6" />
          </button>
        </div>
        <p className={`text-sm ${textColor} mb-4 whitespace-pre-wrap`}>{message}</p>
        <div className="text-right">
          <button onClick={onClose} className="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-500 transition-colors duration-200">
            Tutup
          </button>
        </div>
      </div>
    </div>
  );
};


// Main Application Component
export default function App() {
  // Password Protection State
  const [isLocked, setIsLocked] = useState(true);
  const [passwordInput, setPasswordInput] = useState('');
  const [loginError, setLoginError] = useState('');
  const CORRECT_PASSWORD = 'mutu2025';

  // API Key State
  const [apiKey, setApiKey] = useState('');
  const [isApiKeyInvalid, setIsApiKeyInvalid] = useState(false);

  const [rawData, setRawData] = useState(null);
  const [groupedData, setGroupedData] = useState(null);
  const [fileName, setFileName] = useState('');
  const [error, setError] = useState(''); // For general UI error messages
  const [loadingStates, setLoadingStates] = useState({}); // For per-item/function loading indicators
  const [isProcessingFile, setIsProcessingFile] = useState(false); // For file loading indicator
  const [downloadFormat, setDownloadFormat] = useState('xlsx');
  const [openStates, setOpenStates] = useState({}); // To control UI section open/close state
  const [aiSummary, setAiSummary] = useState(''); // For AI summary
  const [isSummaryLoading, setIsSummaryLoading] = useState(false); // For AI summary loading indicator
  const [generationProgress, setGenerationProgress] = useState({ current: 0, total: 0, message: '' }); // For bulk generation progress bar
  const [documentInventory, setDocumentInventory] = useState(null); // State for the flattened document inventory
  const [groupedDocumentsByTypeForDisplay, setGroupedDocumentsByTypeForDisplay] = useState(null); // State for UI display of grouped documents

  // New states to control visibility of inventory and grouped documents
  const [showDocumentInventory, setShowDocumentInventory] = useState(false);
  const [showDocumentGrouping, setShowDocumentGrouping] = useState(false);
  const [modalMessage, setModalMessage] = useState({ message: '', type: '' }); // State for modal messages (replaces alert)
  const [batchResult, setBatchResult] = useState(null); // State to display batch generate results (success/fail)

  // Firebase State
  const [db, setDb] = useState(null);
  const [userId, setUserId] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false); // To track Firebase auth status

  // --- Password Handling ---
  const handlePasswordSubmit = (e) => {
    e.preventDefault();
    if (passwordInput === CORRECT_PASSWORD) {
        setIsLocked(false);
        setLoginError('');
        setPasswordInput('');
    } else {
        setLoginError('Kata sandi salah. Silakan coba lagi.');
        setPasswordInput('');
    }
  };

  const handleLockApp = () => {
    setIsLocked(true);
  };

  // --- Firebase Initialization and Authentication ---
  useEffect(() => {
    try {
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
      if (!firebaseConfig) {
        console.error("Konfigurasi Firebase tidak ditemukan. Persistensi tidak akan berfungsi.");
        setModalMessage({ message: "Konfigurasi Firebase tidak ditemukan. Fitur penyimpanan data tidak akan berfungsi.", type: 'error' });
        setIsAuthReady(true); // Mark as ready even with config error
        return;
      }

      const app = initializeApp(firebaseConfig);
      const firestoreDb = getFirestore(app);
      const auth = getAuth(app);

      setDb(firestoreDb);

      const unsubscribe = onAuthStateChanged(auth, async (user) => {
        if (user) {
          setUserId(user.uid);
          console.log("Pengguna terautentikasi:", user.uid);
        } else {
          // Sign in anonymously if no user is found and no initial token is provided
          try {
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (initialAuthToken) {
              await signInWithCustomToken(auth, initialAuthToken);
              console.log("Masuk dengan token kustom.");
            } else {
              await signInAnonymously(auth);
              console.log("Masuk secara anonim.");
            }
          } catch (authError) {
            console.error("Kesalahan Otentikasi Firebase:", authError);
            setModalMessage({ message: `Gagal otentikasi Firebase: ${authError.message}`, type: 'error' });
          }
        }
        setIsAuthReady(true); // Authentication attempt is complete
      });

      return () => unsubscribe(); // Cleanup listener on component unmount
    } catch (e) {
      console.error("Kesalahan saat menginisialisasi Firebase:", e);
      setModalMessage({ message: `Gagal menginisialisasi Firebase: ${e.message}`, type: 'error' });
      setIsAuthReady(true);
    }
  }, []); // Run once on component mount

  // --- Firestore Data Persistence (Debounced) ---
  const saveToFirestore = useCallback(async (dataToSave, currentFileName, currentUserId, currentAiSummary) => {
    if (!db || !currentUserId || !currentFileName) {
      console.warn("Melewatkan penyimpanan: Firebase belum siap, pengguna tidak dikenal, atau nama file hilang.");
      return;
    }
    // Prevent saving if there's no meaningful data or if it's an empty initial state
    if (Object.keys(dataToSave).length === 0 && !currentAiSummary) {
      return;
    }
    
    // Use __app_id for the top-level collection specific to this app
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    // Path: /artifacts/{appId}/users/{userId}/{your_collection_name}/{documentId}
    const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/pps_data`, currentFileName);
    
    try {
      await setDoc(docRef, {
        groupedData: dataToSave,
        aiSummary: currentAiSummary, // Also save the AI summary
        timestamp: new Date(),
      }, { merge: true }); // Use merge to avoid overwriting other fields if they exist
      console.log("Data berhasil disimpan ke Firestore!");
    } catch (e) {
      console.error("Kesalahan saat menyimpan ke Firestore:", e);
      // Optionally, set an error state here, but don't block the UI
      setError(`Gagal menyimpan ke cloud: ${e.message}`);
    }
  }, [db]); // Dependency on db

  // Effect to trigger save when groupedData or aiSummary changes and Firebase is ready
  useEffect(() => {
    if (isAuthReady && userId && fileName && groupedData) {
      // Debounce the save operation to avoid too many writes
      const handler = setTimeout(() => {
        saveToFirestore(groupedData, fileName, userId, aiSummary);
      }, 1500); // Save 1.5 seconds after data stabilizes

      return () => {
        clearTimeout(handler);
      };
    }
  }, [groupedData, aiSummary, userId, fileName, isAuthReady, saveToFirestore]);


  const toggleOpen = (id) => setOpenStates(prev => ({ ...prev, [id]: !prev[id] }));

  // Function to process raw data into a structured hierarchy
  const processData = (data) => {
    const groups = {};
    data.forEach((row, index) => {
      // Clean column names and convert to lowercase
      const cleanedRow = Object.keys(row).reduce((acc, key) => {
          acc[key.trim().toLowerCase().replace(/\s+/g, '')] = row[key];
          return acc;
      }, {});
      
      // Find the column key containing the hierarchy code
      const codeKey = Object.keys(cleanedRow).find(k => k.includes('babstandarkriteriaelemenpenilaian') || k.includes('kodeep') || k.includes('kode'));
      if (!codeKey || !cleanedRow[codeKey]) {
        console.warn(`Melewatkan baris ${index}: Kolom kode hierarki tidak ditemukan atau kosong.`);
        return;
      }

      const code = String(cleanedRow[codeKey]);
      const parts = code.split('.');
      if (parts.length < 4) {
        console.warn(`Melewatkan baris ${index}: Kode hierarki tidak valid (kurang dari 4 bagian): ${code}`);
        return;
      }
      
      // Split the hierarchy code into parts
      const [bab, standar, kriteria, ...epParts] = parts;
      const ep = epParts.join('.'); // Re-join EP parts

      // Build the hierarchy structure
      if (!groups[bab]) groups[bab] = { title: `BAB ${bab}`, standards: {} };
      if (!groups[bab].standards[standar]) groups[bab].standards[standar] = { title: `Standar ${standar}`, criterias: {} };
      if (!groups[bab].standards[standar].criterias[kriteria]) {
        groups[bab].standards[standar].criterias[kriteria] = { title: `Kriteria ${kriteria}`, items: [] };
      }
      
      // Populate item data from the Excel row
      const itemData = {
        id: `${code}-${index}`, // Unique ID for each item
        kode_ep: code,
        uraian_ep: cleanedRow['uraianelemenpenilaian'] || '',
        rekomendasi_survey: cleanedRow['rekomendasihasilsurvey'] || '',
        rencana_perbaikan: cleanedRow['rencanaperbaikan'] || '',
        indikator: cleanedRow['indikatorpencapaian'] || cleanedRow['indikator'] || '',
        sasaran: cleanedRow['sasaran'] || '',
        waktu: cleanedRow['waktupenyelesaian'] || cleanedRow['waktu'] || '',
        pj: cleanedRow['penanggungjawab'] || cleanedRow['pj'] || '',
        keterangan: "Klik 'Buat Keterangan'", // Default placeholder
      };
      groups[bab].standards[standar].criterias[kriteria].items.push(itemData);
    });
    return groups;
  };

  const onDrop = useCallback(async (acceptedFiles) => {
    setError(''); setRawData(null); setGroupedData(null); setFileName(''); setAiSummary(''); setDocumentInventory(null); setGroupedDocumentsByTypeForDisplay(null); setShowDocumentInventory(false); setShowDocumentGrouping(false); setModalMessage({ message: '', type: '' }); setBatchResult(null); // Clear all previous states
    setIsProcessingFile(true);
    const file = acceptedFiles[0];
    if (!file) { setModalMessage({ message: "File tidak valid.", type: 'error' }); setIsProcessingFile(false); return; }
    setFileName(file.name); // Set filename immediately

    try {
      await loadXlsxScript(); // Ensure XLSX library is loaded
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const workbook = window.XLSX.read(event.target.result, { type: 'binary' });
          const sheetName = workbook.SheetNames[0]; // Get the first sheet name
          const jsonData = window.XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {defval: ""}); // Convert sheet to JSON
          if(jsonData.length === 0) { 
            setModalMessage({ message: "File Excel kosong atau formatnya tidak bisa dibaca.", type: 'error' }); 
            setRawData(null); // Ensure rawData is reset
            return; 
          }
          setRawData(jsonData); 
          // handleViewHierarchy will be called by effect when rawData is set, including loading from Firestore.
        } catch (e) { 
          setModalMessage({ message: "Terjadi kesalahan saat memproses file Excel. Pastikan format file benar.", type: 'error' });
          console.error("Kesalahan pemprosesan file:", e);
        } finally { 
          setIsProcessingFile(false); 
        }
      };
      reader.onerror = () => { 
        setModalMessage({ message: "Gagal membaca file. Izin mungkin tidak diberikan atau file rusak.", type: 'error' }); 
        setIsProcessingFile(false); 
      }
      reader.readAsBinaryString(file);
    } catch (err) { 
      setModalMessage({ message: err.message, type: 'error' }); 
      setIsProcessingFile(false); 
    }
  }, []);

  const { getRootProps, getInputProps, isDragActive } = useDropzone({ onDrop, accept: { 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx'], 'text/csv': ['.csv'] }, disabled: isProcessingFile });

  // This effect runs when rawData, userId, db, or isAuthReady changes
  // It is responsible for processing data and loading existing data from Firestore
  useEffect(() => {
    const loadAndProcess = async () => {
      // Ensure all prerequisites are met before processing and loading from Firestore
      if (!rawData || !isAuthReady || !userId || !db || !fileName) {
        console.log("Melewatkan pemuatan dan pemprosesan dari Firestore: prasyarat tidak terpenuhi.", { rawData, isAuthReady, userId, db, fileName });
        return;
      }

      setGenerationProgress({ current: 0, total: 0, message: 'Memproses data dan memuat dari cloud...' });
      setError(''); // Clear previous error

      try {
        let processedData = processData(rawData);
        if (Object.keys(processedData).length === 0) {
            setError("Data tidak dapat diproses. Pastikan file Anda memiliki kolom kode hierarki yang valid.");
            setRawData(null); 
            setGenerationProgress({ current: 0, total: 0, message: '' });
            return;
        }

        // Try to load existing data from Firestore for this file and user
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const docRef = doc(db, `artifacts/${appId}/users/${userId}/pps_data`, fileName);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          console.log("Data yang ada ditemukan di Firestore untuk file:", fileName);
          const savedData = docSnap.data();
          const savedGroupedData = savedData.groupedData;
          const savedAiSummary = savedData.aiSummary;
          console.log("Ringkasan AI dimuat dari Firestore:", savedAiSummary);

          // Merge saved data into the newly processed data
          // We will only overwrite saved fields if they exist in the newly processed data
          for (const babKey in processedData) {
            if (savedGroupedData && savedGroupedData[babKey]) {
              for (const stdKey in processedData[babKey].standards) {
                if (savedGroupedData[babKey].standards[stdKey]) {
                  for (const kriKey in processedData[babKey].standards[stdKey].criterias) {
                    if (savedGroupedData[babKey].standards[stdKey].criterias[kriKey]) {
                      processedData[babKey].standards[stdKey].criterias[kriKey].items = 
                        processedData[babKey].standards[stdKey].criterias[kriKey].items.map(newItem => {
                          const existingItem = savedGroupedData[babKey].standards[stdKey].criterias[kriKey].items.find(si => si.id === newItem.id);
                          // Merge only desired fields from existingItem if it exists
                          if (existingItem) {
                            return { 
                              ...newItem, // Keep original data from the file
                              rencana_perbaikan: existingItem.rencana_perbaikan || newItem.rencana_perbaikan,
                              indikator: existingItem.indikator || newItem.indikator,
                              sasaran: existingItem.sasaran || newItem.sasaran,
                              keterangan: existingItem.keterangan || newItem.keterangan,
                              waktu: existingItem.waktu || newItem.waktu, // Ensure waktu and PJ are also merged
                              pj: existingItem.pj || newItem.pj,
                            };
                          }
                          return newItem;
                        });
                    }
                  }
                }
              }
            }
          }
          setAiSummary(savedAiSummary || ''); // Load saved summary
        } else {
          console.log("Tidak ada data yang ada ditemukan di Firestore untuk file:", fileName);
          setAiSummary(''); // Clear summary if no saved data
        }
        setGroupedData(processedData); // Set the processed or merged data
        setGenerationProgress({ current: 0, total: 0, message: '' });
      } catch (e) { 
        setError("Terjadi kesalahan saat membuat hierarki atau memuat data dari cloud."); 
        console.error("Kesalahan pemprosesan hierarki atau pemuatan Firestore:", e);
        setGenerationProgress({ current: 0, total: 0, message: '' });
      }
    };

    if (rawData && isAuthReady && userId && db && fileName) {
      loadAndProcess();
    }
  }, [rawData, userId, db, isAuthReady, fileName]); // Important dependencies

  // Function to update an item's state in groupedData (immutable update)
  const updateItemState = useCallback((itemId, field, value) => {
    setGroupedData(prevGroupedData => {
      // Ensure prevGroupedData is not null or undefined
      if (!prevGroupedData) return prevGroupedData;

      // Create a deep copy of groupedData so changes don't affect the original object
      const newGroupedData = JSON.parse(JSON.stringify(prevGroupedData));

      for (const babKey in newGroupedData) {
        const bab = newGroupedData[babKey];
        
        for (const stdKey in bab.standards) {
          const standard = bab.standards[stdKey];
          
          for (const kriKey in standard.criterias) {
            const criteria = standard.criterias[kriKey];
            
            const itemIndex = criteria.items.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
              criteria.items[itemIndex][field] = value;
              return newGroupedData; // Return the updated state
            }
          }
        }
      }
      // If the item is not found, return the previous state
      return prevGroupedData;
    });
  }, []); // Empty dependency because this function only modifies state via setGroupedData

  // Function to call the Google AI API
  const callAiApi = async (prompt) => {
    if (!apiKey) {
      setIsApiKeyInvalid(true);
      throw new Error("API_KEY_MISSING");
    }
    setIsApiKeyInvalid(false);

    const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
    
    let response;
    try {
        response = await fetch(apiUrl, {
            method: 'POST',
            mode: 'cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
    } catch (networkError) {
        console.error("Kesalahan Jaringan selama fetch:", networkError);
        throw new Error("NETWORK_ERROR");
    }

    const responseText = await response.text();

    if (!response.ok) {
        let errorMsg = `Kesalahan HTTP! status: ${response.status}`;
        if (responseText) {
            try {
                const errorBody = JSON.parse(responseText);
                if (response.status === 400 && errorBody?.error?.message.toLowerCase().includes("api key not valid")) {
                    setIsApiKeyInvalid(true);
                    throw new Error("API_KEY_INVALID");
                }
                errorMsg += ` - ${errorBody?.error?.message || 'Tidak dikenal.'}`;
            } catch (e) {
                errorMsg += ` - Respons error tidak dapat dibaca.`;
            }
        }
        throw new Error(errorMsg);
    }

    if (!responseText) {
        throw new Error("EMPTY_RESPONSE");
    }

    let result;
    try {
        result = JSON.parse(responseText);
    } catch (e) {
        console.error("Gagal mem-parsing JSON:", responseText);
        throw new Error("INVALID_JSON");
    }
    
    if (!result.candidates || result.candidates.length === 0) {
        if (result.promptFeedback && result.promptFeedback.blockReason) {
            console.warn("Prompt diblokir karena:", result.promptFeedback.blockReason);
            throw new Error(`PROMPT_BLOCKED: ${result.promptFeedback.blockReason}`);
        }
        throw new Error("NO_CANDIDATES");
    }

    if (result.candidates[0].finishReason === 'SAFETY') {
        console.warn("Respons diblokir karena alasan keamanan.");
        throw new Error("RESPONSE_BLOCKED_SAFETY");
    }

    if (result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
        return result.candidates[0].content.parts[0].text.trim().replace(/^"|"$/g, '');
    }
    
    return "Respons AI tidak valid atau kosong.";
  };

  // Function to display error messages using the custom modal
  const handleApiError = (e) => {
    let message = `Gagal menghubungi AI: ${e.message}`;
    if (e.message === "API_KEY_MISSING") {
        message = "Harap masukkan Kunci API Google AI Anda terlebih dahulu.";
        setIsApiKeyInvalid(true);
    } else if (e.message === "API_KEY_INVALID") {
        message = "Kunci API tidak valid. Harap periksa kembali kunci API dari Google AI Studio dan coba lagi.";
        setIsApiKeyInvalid(true);
    } else if (e.message === "NETWORK_ERROR") {
        message = "Gagal terhubung ke server AI. Mohon periksa koneksi internet Anda.";
    } else if (e.message === "EMPTY_RESPONSE") {
        message = "AI memberikan respons kosong. Ini mungkin karena filter keamanan. Coba ubah input Anda atau coba lagi.";
    } else if (e.message === "INVALID_JSON") {
        message = "AI memberikan respons yang tidak valid. Silakan coba lagi.";
    } else if (e.message.startsWith("PROMPT_BLOCKED")) {
        message = "Permintaan Anda diblokir oleh filter keamanan AI. Harap ubah input Anda.";
    } else if (e.message === "RESPONSE_BLOCKED_SAFETY") {
        message = "Respons dari AI diblokir oleh filter keamanan. Silakan coba lagi.";
    } else if (e.message === "NO_CANDIDATES") {
        message = "AI tidak memberikan hasil. Ini bisa jadi karena filter keamanan. Coba ubah input Anda.";
    }
    setModalMessage({ message, type: 'error' });
    console.error("Kesalahan API yang ditangani:", e);
  };

  // Helper to clean AI input strings from placeholders or error messages
  const cleanAiInput = (text) => {
    if (typeof text !== 'string' && text !== null && text !== undefined) {
      text = String(text); // Convert to string if not a string
    }
    if (!text) return ''; // Handle null, undefined, empty string after conversion
    const cleaned = text.trim();
    // Remove placeholder/error messages that might have been generated by AI previously
    if (cleaned.includes('Klik \'Buat Keterangan\'') || 
        cleaned.includes('Gagal diproses') || 
        cleaned.includes('Input data tidak siap') ||
        cleaned.includes('Batas permintaan AI tercapai') ||
        cleaned.includes('Data tidak cukup') ||
        cleaned.includes('Gagal setelah beberapa percobaan')) {
        return '';
    }
    return cleaned;
  };

  // Function to generate Keterangan (Implementation Evidence) using AI
  const handleGenerateKeterangan = async (item) => {
    // Sanitize inputs before sending to AI
    const cleanedRencanaPerbaikan = cleanAiInput(item.rencana_perbaikan);
    const cleanedIndikator = cleanAiInput(item.indikator);
    const cleanedSasaran = cleanAiInput(item.sasaran);

    if (!cleanedRencanaPerbaikan && !cleanedIndikator && !cleanedSasaran) {
        // Update item status directly in UI for instant feedback
        updateItemState(item.id, 'keterangan', 'Input data tidak siap (isi RTL/Indikator/Sasaran)');
        return;
    }
    // Set loading state for this specific item
    setLoadingStates(prev => ({ ...prev, [item.id + '_ket']: true }));
    const prompt = `PERAN: Anda adalah auditor akreditasi. TUGAS: Buatkan satu judul DOKUMEN BUKTI IMPLEMENTASI yang konkret berdasarkan data berikut. DATA: - Rencana Perbaikan: "${cleanedRencanaPerbaikan}" - Indikator: "${cleanedIndikator}" - Sasaran: "${cleanedSasaran}". ATURAN: Jawaban harus berupa satu frasa/kalimat tunggal, spesifik, dan dalam format nama dokumen resmi (contoh: "SK Rektor tentang...", "Notulensi Rapat...", "Laporan Hasil...").`;
    
    let success = false;
    let attempts = 0;
    const MAX_ATTEMPTS = 3;
    const RETRY_DELAY_MS = 2000; // 2 second delay for retry

    while (!success && attempts < MAX_ATTEMPTS) {
        try {
            const generatedText = await callAiApi(prompt);
            if (generatedText === 'RATE_LIMIT') {
                attempts++;
                updateItemState(item.id, 'keterangan', `Batas permintaan AI tercapai, mencoba lagi... (percobaan ${attempts}/${MAX_ATTEMPTS})`);
                await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                continue; // Continue to next attempt
            }
            updateItemState(item.id, 'keterangan', generatedText);
            success = true; // Success, exit loop
        } catch (e) {
            handleApiError(e); // Display global API error via modal
            updateItemState(item.id, 'keterangan', `Gagal diproses: ${e.message}`); // Update item with error message
            success = true; // Stop trying if it's not a rate limit error
        }
    }

    if (!success) {
        updateItemState(item.id, 'keterangan', 'Gagal setelah beberapa percobaan (Rate Limit)'); // Final message if all attempts fail
    }
    setLoadingStates(prev => ({ ...prev, [item.id + '_ket']: false })); // Remove loading state
  };

  // Function to generate Rencana Perbaikan (RTL) using AI
  const handleGenerateRTL = async (item) => {
     const cleanedUraianEp = cleanAiInput(item.uraian_ep);
     const cleanedRekomendasiSurvey = cleanAiInput(item.rekomendasi_survey);

     if (!cleanedUraianEp && !cleanedRekomendasiSurvey) {
        updateItemState(item.id, 'rencana_perbaikan', 'Data tidak cukup untuk ide RTL');
        return;
    }
    setLoadingStates(prev => ({ ...prev, [item.id + '_rtl']: true }));
    const prompt = `PERAN: Anda adalah konsultan mutu. TUGAS: Buatkan satu kalimat RENCANA PERBAIKAN (RTL) yang operasional dan terukur. DATA: - Uraian Elemen Penilaian: "${cleanedUraianEp}" - Rekomendasi Awal: "${cleanedRekomendasiSurvey}". ATURAN: Jawaban harus berupa kalimat tindakan yang jelas. Contoh: "Melakukan sosialisasi SOP pendaftaran pasien baru kepada seluruh petugas pendaftaran."`;
    
    let success = false;
    let attempts = 0;
    const MAX_ATTEMPTS = 3;
    const RETRY_DELAY_MS = 2000;

    while (!success && attempts < MAX_ATTEMPTS) {
        try {
            const generatedText = await callAiApi(prompt);
            if (generatedText === 'RATE_LIMIT') {
                attempts++;
                updateItemState(item.id, 'rencana_perbaikan', `Batas permintaan AI tercapai, mencoba lagi... (percobaan ${attempts}/${MAX_ATTEMPTS})`);
                await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                continue;
            }
            updateItemState(item.id, 'rencana_perbaikan', generatedText);
            success = true;
        } catch (e) {
            handleApiError(e);
            updateItemState(item.id, 'rencana_perbaikan', `Gagal diproses: ${e.message}`);
            success = true;
        } 
    }
    if (!success) {
        updateItemState(item.id, 'rencana_perbaikan', 'Gagal setelah beberapa percobaan (Rate Limit)');
    }
    setLoadingStates(prev => ({ ...prev, [item.id + '_rtl']: false }));
  };

  // Function to generate Indikator using AI
  const handleGenerateIndikator = async (item) => {
    const cleanedUraianEp = cleanAiInput(item.uraian_ep);
    const cleanedRencanaPerbaikan = cleanAiInput(item.rencana_perbaikan);

    if (!cleanedUraianEp && !cleanedRencanaPerbaikan) {
      updateItemState(item.id, 'indikator', 'Data tidak cukup untuk indikator');
      return;
    }
    setLoadingStates(prev => ({ ...prev, [item.id + '_indikator']: true }));
    const prompt = `PERAN: Anda adalah seorang perencana mutu. TUGAS: Buatkan satu poin indikator pencapaian yang spesifik, terukur, dan relevan untuk rencana perbaikan berikut. DATA: - Uraian Elemen Penilaian: "${cleanedUraianEp}" - Rencana Perbaikan: "${cleanedRencanaPerbaikan}". ATURAN: Jawaban harus berupa frasa indikator yang jelas (contoh: "Persentase pasien yang mendapatkan edukasi sesuai standar").`;
    
    let success = false;
    let attempts = 0;
    const MAX_ATTEMPTS = 3;
    const RETRY_DELAY_MS = 2000;

    while (!success && attempts < MAX_ATTEMPTS) {
      try {
        const generatedText = await callAiApi(prompt);
        if (generatedText === 'RATE_LIMIT') {
          attempts++;
          updateItemState(item.id, 'indikator', `Batas permintaan AI tercapai, mencoba lagi... (percobaan ${attempts}/${MAX_ATTEMPTS})`);
          await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
          continue;
        }
        updateItemState(item.id, 'indikator', generatedText);
        success = true;
      } catch (e) { 
        handleApiError(e);
        updateItemState(item.id, 'indikator', `Gagal diproses: ${e.message}`);
        success = true;
      } 
    }
    if (!success) {
      updateItemState(item.id, 'indikator', 'Gagal setelah beberapa percobaan (Rate Limit)');
    }
    setLoadingStates(prev => ({ ...prev, [item.id + '_indikator']: false }));
  };

  // Function to generate Sasaran using AI
  const handleGenerateSasaran = async (item) => {
    const cleanedUraianEp = cleanAiInput(item.uraian_ep);
    const cleanedRencanaPerbaikan = cleanAiInput(item.rencana_perbaikan);

    if (!cleanedUraianEp && !cleanedRencanaPerbaikan) {
      updateItemState(item.id, 'sasaran', 'Data tidak cukup untuk sasaran');
      return;
    }
    setLoadingStates(prev => ({ ...prev, [item.id + '_sasaran']: true }));
    const prompt = `PERAN: Anda adalah seorang manajer strategi. TUGAS: Buatkan satu poin sasaran yang jelas dan berorientasi hasil untuk rencana perbaikan berikut. DATA: - Uraian Elemen Penilaian: "${cleanedUraianEp}" - Rencana Perbaikan: "${cleanedRencanaPerbaikan}". ATURAN: Jawaban harus berupa kalimat sasaran yang ringkas (contoh: "Meningkatnya kepuasan pasien terhadap pelayanan pendaftaran.").`;
    
    let success = false;
    let attempts = 0;
    const MAX_ATTEMPTS = 3;
    const RETRY_DELAY_MS = 2000;

    while (!success && attempts < MAX_ATTEMPTS) {
      try {
        const generatedText = await callAiApi(prompt);
        if (generatedText === 'RATE_LIMIT') {
          attempts++;
          updateItemState(item.id, 'sasaran', `Batas permintaan AI tercapai, mencoba lagi... (percobaan ${attempts}/${MAX_ATTEMPTS})`);
          await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
          continue;
        }
        updateItemState(item.id, 'sasaran', generatedText);
        success = true;
      } catch (e) {
        handleApiError(e);
        updateItemState(item.id, 'sasaran', `Gagal diproses: ${e.message}`);
        success = true;
      } 
    }
    if (!success) {
      updateItemState(item.id, 'sasaran', 'Gagal setelah beberapa percobaan (Rate Limit)');
    }
    setLoadingStates(prev => ({ ...prev, [item.id + '_sasaran']: false }));
  };
  
  // Function to prepare flattened document inventory data (for general list)
  const prepareDocumentInventoryData = useCallback(() => {
    if (!groupedData) return [];

    const inventoryMap = new Map(); // Map to store unique documents and their related EPs

    Object.values(groupedData).forEach(bab => {
      Object.values(bab.standards).forEach(standard => {
        Object.values(standard.criterias).forEach(criteria => {
          criteria.items.forEach(item => {
            const docTitle = cleanAiInput(item.keterangan); // Clean before using
            if (docTitle) { // Only add if cleaned title is not empty
              if (!inventoryMap.has(docTitle)) {
                inventoryMap.set(docTitle, { kode_ep_list: new Set(), uraian_ep_list: new Set() });
              }
              inventoryMap.get(docTitle).kode_ep_list.add(item.kode_ep);
              inventoryMap.get(docTitle).uraian_ep_list.add(item.uraian_ep);
            }
          });
        });
      });
    });

    // Convert Set to Array and sort before joining
    const flattenedInventory = Array.from(inventoryMap).map(([docTitle, data]) => ({
      'Judul Dokumen (Keterangan)': docTitle,
      'Kode Elemen Penilaian Terkait': Array.from(data.kode_ep_list).sort().join(', '),
      'Uraian Elemen Penilaian Terkait': Array.from(data.uraian_ep_list).sort().join('; '),
    }));

    return flattenedInventory;
  }, [groupedData]);

  // NEW: Function to prepare documents grouped by type (for UI display)
  const prepareGroupedDocumentDataForDisplay = useCallback(() => {
    if (!groupedData) return {};

    const groupedByType = {};

    const getDocumentType = (keterangan) => {
        const lowerKeterangan = keterangan.toLowerCase();
        // More comprehensive document type identification logic
        if (lowerKeterangan.startsWith('sk ')) return 'SK (Surat Keputusan)';
        if (lowerKeterangan.startsWith('sop ') || lowerKeterangan.includes('standar operasional prosedur')) return 'SOP (Standar Operasional Prosedur)';
        if (lowerKeterangan.includes('notulen') || lowerKeterangan.includes('notulensi') || lowerKeterangan.includes('risalah rapat')) return 'Notulen Rapat';
        if (lowerKeterangan.includes('laporan')) return 'Laporan';
        if (lowerKeterangan.includes('pedoman')) return 'Pedoman';
        if (lowerKeterangan.includes('panduan')) return 'Panduan';
        if (lowerKeterangan.includes('kak') || lowerKeterangan.includes('kerangka acuan kegiatan')) return 'KAK (Kerangka Acuan Kegiatan)';
        if (lowerKeterangan.includes('bukti evaluasi') || lowerKeterangan.includes('hasil evaluasi') || lowerKeterangan.includes('hasil penilaian')) return 'Bukti Evaluasi/Penilaian';
        if (lowerKeterangan.includes('bukti tindak lanjut') || lowerKeterangan.includes('laporan tindak lanjut')) return 'Bukti Tindak Lanjut';
        if (lowerKeterangan.includes('daftar hadir')) return 'Daftar Hadir';
        if (lowerKeterangan.includes('form') || lowerKeterangan.includes('formulir') || lowerKeterangan.includes('lembar')) return 'Formulir/Lembar Kerja';
        if (lowerKeterangan.includes('surat edaran') || lowerKeterangan.includes('memo') || lowerKeterangan.includes('instruksi kerja')) return 'Surat Edaran/Internal';
        if (lowerKeterangan.includes('profil') || lowerKeterangan.includes('data program')) return 'Profil/Data Program';
        if (lowerKeterangan.includes('bukti sosialisasi') || lowerKeterangan.includes('materi sosialisasi')) return 'Bukti Sosialisasi';
        if (lowerKeterangan.includes('bukti pelaksanaan') || lowerKeterangan.includes('dokumentasi kegiatan')) return 'Bukti Pelaksanaan Kegiatan';
        
        return 'Dokumen Umum / Lain-lain'; // Clearer default category
    };

    Object.values(groupedData).forEach(bab => {
        Object.values(bab.standards).forEach(standard => {
            Object.values(standard.criterias).forEach(criteria => {
                criteria.items.forEach(item => {
                    const docTitle = cleanAiInput(item.keterangan); // Clean before using
                    if (docTitle) { // Only add if cleaned title is not empty
                        const type = getDocumentType(docTitle);
                        if (!groupedByType[type]) {
                            groupedByType[type] = [];
                        }
                        groupedByType[type].push({
                            'Judul Dokumen': docTitle,
                            'Kode EP Terkait': item.kode_ep,
                            'Uraian EP Terkait': item.uraian_ep,
                            'Rencana Perbaikan': item.rencana_perbaikan, // Include raw for display, cleaned for AI prompt
                            'Indikator': item.indikator,
                            'Sasaran': item.sasaran,
                            'Waktu': item.waktu,
                            'PJ': item.pj,
                        });
                    }
                });
            });
        });
    });
    return groupedByType;
  }, [groupedData]);

  // NEW: Function to prepare documents grouped by type, flattened for Excel export
  const prepareGroupedDocumentDataForExcel = useCallback(() => {
    if (!groupedData) return [];

    const flattenedForExcel = [];

    // Use the same getDocumentType function for consistency
    const getDocumentType = (keterangan) => {
      const lowerKeterangan = keterangan.toLowerCase();
      if (lowerKeterangan.startsWith('sk ')) return 'SK (Surat Keputusan)';
      if (lowerKeterangan.startsWith('sop ') || lowerKeterangan.includes('standar operasional prosedur')) return 'SOP (Standar Operasional Prosedur)';
      if (lowerKeterangan.includes('notulen') || lowerKeterangan.includes('notulensi') || lowerKeterangan.includes('risalah rapat')) return 'Notulen Rapat';
      if (lowerKeterangan.includes('laporan')) return 'Laporan';
      if (lowerKeterangan.includes('pedoman')) return 'Pedoman';
      if (lowerKeterangan.includes('panduan')) return 'Panduan';
      if (lowerKeterangan.includes('kak') || lowerKeterangan.includes('kerangka acuan kegiatan')) return 'KAK (Kerangka Acuan Kegiatan)';
      if (lowerKeterangan.includes('bukti evaluasi') || lowerKeterangan.includes('hasil evaluasi') || lowerKeterangan.includes('hasil penilaian')) return 'Bukti Evaluasi/Penilaian';
      if (lowerKeterangan.includes('bukti tindak lanjut') || lowerKeterangan.includes('laporan tindak lanjut')) return 'Bukti Tindak Lanjut';
      if (lowerKeterangan.includes('daftar hadir')) return 'Daftar Hadir';
      if (lowerKeterangan.includes('form') || lowerKeterangan.includes('formulir') || lowerKeterangan.includes('lembar')) return 'Formulir/Lembar Kerja';
      if (lowerKeterangan.includes('surat edaran') || lowerKeterangan.includes('memo') || lowerKeterangan.includes('instruksi kerja')) return 'Surat Edaran/Internal';
      if (lowerKeterangan.includes('profil') || lowerKeterangan.includes('data program')) return 'Profil/Data Program';
      if (lowerKeterangan.includes('bukti sosialisasi') || lowerKeterangan.includes('materi sosialisasi')) return 'Bukti Sosialisasi';
      if (lowerKeterangan.includes('bukti pelaksanaan') || lowerKeterangan.includes('dokumentasi kegiatan')) return 'Bukti Pelaksanaan Kegiatan';
      return 'Dokumen Umum / Lain-lain';
    };

    Object.values(groupedData).forEach(bab => {
        Object.values(bab.standards).forEach(standard => {
            Object.values(standard.criterias).forEach(criteria => {
                criteria.items.forEach(item => {
                    const docTitle = cleanAiInput(item.keterangan); // Clean before using
                    if (docTitle) { // Only add if cleaned title is not empty
                        const type = getDocumentType(docTitle);
                        flattenedForExcel.push({
                            'Tipe Dokumen': type, // New column for type
                            'Judul Dokumen': docTitle,
                            'Kode EP Terkait': item.kode_ep,
                            'Uraian EP Terkait': item.uraian_ep,
                            'Rencana Perbaikan': item.rencana_perbaikan, 
                            'Indikator': item.indikator,
                            'Sasaran': item.sasaran,
                            'Waktu': item.waktu,
                            'PJ': item.pj,
                        });
                    }
                });
            });
        });
    });
    // Sort by document type for better organization in Excel
    return flattenedForExcel.sort((a, b) => a['Tipe Dokumen'].localeCompare(b['Tipe Dokumen']));
  }, [groupedData]);


  // Effect to update document inventory and grouped documents when groupedData changes
  useEffect(() => {
    setDocumentInventory(prepareDocumentInventoryData());
    setGroupedDocumentsByTypeForDisplay(prepareGroupedDocumentDataForDisplay()); // Update new state for UI
  }, [groupedData, prepareDocumentInventoryData, prepareGroupedDocumentDataForDisplay]);

  // --- NEW BULK AI GENERATION FUNCTIONS ---

  // Generic helper function for the bulk AI generation process
  const handleGenerateAllField = async (fieldToGenerate, loadingStateSuffix, promptRole, promptTask, itemFilterCondition, targetField, getPromptData) => {
    if (!groupedData) { setModalMessage({ message: "Harap tampilkan hierarki terlebih dahulu.", type: 'info' }); return; }
    if (!apiKey) { setModalMessage({ message: "Harap masukkan Kunci API Google AI Anda.", type: 'error' }); setIsApiKeyInvalid(true); return; }

    const allItems = Object.values(groupedData).flatMap(bab => Object.values(bab.standards).flatMap(std => Object.values(std.criterias).flatMap(kri => kri.items)));
    
    // Filter items that meet the condition and are not yet filled
    const itemsToProcess = allItems.filter(item => {
        const isFieldFilled = cleanAiInput(item[targetField]) !== '';
        return itemFilterCondition(item) && !isFieldFilled;
    });
    
    if (itemsToProcess.length === 0) {
        setModalMessage({ message: `Tidak ada item yang perlu diproses untuk '${fieldToGenerate}'. Pastikan item memiliki data input yang dibutuhkan dan kolom target masih kosong atau berisi pesan kesalahan.`, type: 'info' });
        return;
    }

    setGenerationProgress({ current: 0, total: itemsToProcess.length, message: `Memulai proses 'Buat Semua ${fieldToGenerate}'...` });
    setError(''); // Clear general UI error before starting new batch process

    let successfulGenerations = 0;
    let failedGenerations = 0;
    
    const CHUNK_SIZE = 5;
    const DELAY_BETWEEN_CHUNKS = 1500;
    const RETRY_DELAY_MS = 3000;

    try {
        let processedCount = 0;
        for (let i = 0; i < itemsToProcess.length; i += CHUNK_SIZE) {
            setGenerationProgress(prev => ({ ...prev, message: `Memproses kumpulan ${Math.floor(i / CHUNK_SIZE) + 1} dari ${Math.ceil(itemsToProcess.length / CHUNK_SIZE)} untuk '${fieldToGenerate}'...` }));
            const chunk = itemsToProcess.slice(i, i + CHUNK_SIZE);
            
            const processChunkItem = async (item) => {
                const promptData = getPromptData(item); // Get specific prompt data for this item and field
                const prompt = `PERAN: ${promptRole}. TUGAS: ${promptTask}. DATA: ${promptData}.`;
                
                let attempts = 0;
                const MAX_ATTEMPTS = 3;
                while (attempts < MAX_ATTEMPTS) {
                    try {
                        updateItemState(item.id, targetField, 'Memproses...');
                        setLoadingStates(prev => ({ ...prev, [`${item.id}_${loadingStateSuffix}`]: true }));
                        const generatedText = await callAiApi(prompt);
                        if (generatedText === 'RATE_LIMIT') {
                            attempts++;
                            updateItemState(item.id, targetField, `Batas permintaan AI tercapai, mencoba lagi... (percobaan ${attempts}/${MAX_ATTEMPTS})`);
                            await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                            continue;
                        }
                        updateItemState(item.id, targetField, generatedText); 
                        setLoadingStates(prev => ({ ...prev, [`${item.id}_${loadingStateSuffix}`]: false }));
                        successfulGenerations++; // Increment success count
                        return;
                    } catch (error) {
                        handleApiError(error);
                        updateItemState(item.id, targetField, `Gagal diproses: ${error.message}`); 
                        setLoadingStates(prev => ({ ...prev, [`${item.id}_${loadingStateSuffix}`]: false }));
                        failedGenerations++; // Increment fail count
                        return; // Exit on non-rate-limit error
                    }
                }
                updateItemState(item.id, targetField, 'Gagal setelah beberapa percobaan (Rate Limit)'); 
                setLoadingStates(prev => ({ ...prev, [`${item.id}_${loadingStateSuffix}`]: false }));
                failedGenerations++; // Increment fail count if all retries fail
            };

            await Promise.all(chunk.map(processChunkItem));

            processedCount += chunk.length;
            setGenerationProgress(prev => ({ ...prev, current: processedCount }));
            
            if (i + CHUNK_SIZE < itemsToProcess.length) {
                await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_CHUNKS));
            }
        }
        setError('');
        setBatchResult({ success: successfulGenerations, failed: failedGenerations, field: fieldToGenerate }); // Set batch result
    } catch (e) {
        console.error(`Kesalahan fatal selama 'Buat Semua ${fieldToGenerate}':`, e);
        setModalMessage({ message: `Terjadi kesalahan fatal selama 'Buat Semua ${fieldToGenerate}': ${e.message}`, type: 'error' });
    } finally { 
        setGenerationProgress({ current: 0, total: 0, message: '' }); 
    }
  };

  // Specific implementation for Generate All RTL
  const handleGenerateAllRTL = () => {
    const itemFilterCondition = (item) => cleanAiInput(item.uraian_ep) || cleanAiInput(item.rekomendasi_survey);
    const getPromptData = (item) => `- Uraian Elemen Penilaian: "${cleanAiInput(item.uraian_ep)}" - Rekomendasi Awal: "${cleanAiInput(item.rekomendasi_survey)}". ATURAN: Jawaban harus berupa kalimat tindakan yang jelas. Contoh: "Melakukan sosialisasi SOP pendaftaran pasien baru kepada seluruh petugas pendaftaran."`;
    handleGenerateAllField('Rencana Perbaikan', '_rtl', 'Anda adalah konsultan mutu', 'Buatkan satu kalimat RENCANA PERBAIKAN (RTL) yang operasional dan terukur', itemFilterCondition, 'rencana_perbaikan', getPromptData);
  };

  // Specific implementation for Generate All Indikator
  const handleGenerateAllIndikator = () => {
    const itemFilterCondition = (item) => cleanAiInput(item.uraian_ep) || cleanAiInput(item.rencana_perbaikan);
    const getPromptData = (item) => `- Uraian Elemen Penilaian: "${cleanAiInput(item.uraian_ep)}" - Rencana Perbaikan: "${cleanAiInput(item.rencana_perbaikan)}". ATURAN: Jawaban harus berupa frasa indikator yang jelas (contoh: "Persentase pasien yang mendapatkan edukasi sesuai standar").`;
    handleGenerateAllField('Indikator', '_indikator', 'Anda adalah seorang perencana mutu', 'Buatkan satu poin indikator pencapaian yang spesifik, terukur, dan relevan', itemFilterCondition, 'indikator', getPromptData);
  };

  // Specific implementation for Generate All Sasaran
  const handleGenerateAllSasaran = () => {
    const itemFilterCondition = (item) => cleanAiInput(item.uraian_ep) || cleanAiInput(item.rencana_perbaikan);
    const getPromptData = (item) => `- Uraian Elemen Penilaian: "${cleanAiInput(item.uraian_ep)}" - Rencana Perbaikan: "${cleanAiInput(item.rencana_perbaikan)}". ATURAN: Jawaban harus berupa kalimat sasaran yang ringkas (contoh: "Meningkatnya kepuasan pasien terhadap pelayanan pendaftaran.").`;
    handleGenerateAllField('Sasaran', '_sasaran', 'Anda adalah seorang manajer strategi', 'Buatkan satu poin sasaran yang jelas dan berorientasi hasil', itemFilterCondition, 'sasaran', getPromptData);
  };

  // REFACTORED: Function for Generate All Keterangan
  const handleGenerateAllKeterangan = () => {
    const itemFilterCondition = (item) => (cleanAiInput(item.rencana_perbaikan) || cleanAiInput(item.indikator) || cleanAiInput(item.sasaran));
    const getPromptData = (item) => {
        const cleanedRencanaPerbaikan = cleanAiInput(item.rencana_perbaikan);
        const cleanedIndikator = cleanAiInput(item.indikator);
        const cleanedSasaran = cleanAiInput(item.sasaran);
        return `- Rencana Perbaikan: "${cleanedRencanaPerbaikan}" - Indikator: "${cleanedIndikator}" - Sasaran: "${cleanedSasaran}". ATURAN: Jawaban harus berupa satu frasa/kalimat tunggal, spesifik, dan dalam format nama dokumen resmi (contoh: "SK Rektor tentang...", "Notulensi Rapat...", "Laporan Hasil...").`;
    };
    handleGenerateAllField(
        'Keterangan',
        '_ket',
        'Anda adalah auditor akreditasi',
        'Buatkan satu judul DOKUMEN BUKTI IMPLEMENTASI yang konkret berdasarkan data berikut',
        itemFilterCondition,
        'keterangan',
        getPromptData
    );
  };

  // Function to generate a strategic summary using AI
  const handleGenerateSummary = async () => {
    if (!groupedData) { setModalMessage({ message: "Harap tampilkan hierarki terlebih dahulu.", type: 'info' }); return; }
    if (!apiKey) { setModalMessage({ message: "Harap masukkan Kunci API Google AI Anda.", type: 'error' }); setIsApiKeyInvalid(true); return; }

    setIsSummaryLoading(true);
    setAiSummary(''); // Clear previous summary

    // Collect all cleaned improvement plans for the summary prompt
    const allItemsText = Object.values(groupedData).flatMap(bab => 
        Object.values(bab.standards).flatMap(std => 
            Object.values(std.criterias).flatMap(kri => 
                kri.items.filter(item => cleanAiInput(item.rencana_perbaikan)).map(item => `Elemen ${item.kode_ep}: ${cleanAiInput(item.rencana_perbaikan)}`)
            )
        )
    ).join('\n');

    if (!allItemsText.trim()) { // Check after trim
        setAiSummary('Tidak ada Rencana Perbaikan yang cukup untuk dibuat kesimpulan.');
        setIsSummaryLoading(false);
        return;
    }

    const prompt = `PERAN: Anda adalah seorang manajer mutu senior. 
    TUGAS: Analisis semua rencana perbaikan (RTL) yang diberikan. Kelompokkan Elemen Penilaian (EP) yang relevan ke dalam kategori kegiatan strategis berikut:
    1.  **Audit Mutu Internal**: EP yang perlu diperiksa kepatuhan dan pelaksanaannya secara internal (misal: audit dokumen, audit kepatuhan SOP).
    2.  **Sosialisasi & Pelatihan Internal**: EP yang membutuhkan peningkatan pemahaman atau pelatihan untuk staf di dalam Puskesmas.
    3.  **Konsultasi & Bimbingan Teknis Eksternal (contoh: Dinkes)**: EP yang secara spesifik membutuhkan arahan, bimbingan teknis, koordinasi, atau konsultasi dari pihak eksternal seperti Dinas Kesehatan.
    4.  **Peningkatan Monev Internal Rutin**: EP yang hasilnya perlu dipantau secara berkala (misal: monitoring capaian indikator mingguan/bulanan).
    5.  **Kegiatan Lainnya**: Kelompokkan EP lain ke dalam kegiatan spesifik yang Anda identifikasi (contoh: 'Pengembangan/Revisi Dokumen SOP', 'Perbaikan Sarana & Prasarana').

    DATA RTL:\n${allItemsText}\n\nATURAN: Berikan jawaban dalam format Markdown. Gunakan heading untuk setiap kategori. Di bawah setiap heading, sebutkan kode EP yang relevan.`;
    
    let success = false;
    let attempts = 0;
    const MAX_ATTEMPTS = 3;
    const RETRY_DELAY_MS = 5000; // 5 second delay for summary retry

    while(!success && attempts < MAX_ATTEMPTS) {
        try {
            const generatedText = await callAiApi(prompt);
            if (generatedText === 'RATE_LIMIT') {
                attempts++;
                setAiSummary(`Batas permintaan AI tercapai. Mencoba lagi dalam ${RETRY_DELAY_MS / 1000} detik... (percobaan ${attempts}/${MAX_ATTEMPTS})`);
                await new Promise(resolve => setTimeout(resolve, RETRY_DELAY_MS));
                continue;
            }
            setAiSummary(generatedText);
            success = true;
        } catch (e) {
            handleApiError(e); // Display error in the dedicated message area
            setAiSummary(`**Terjadi Kesalahan:**\n\nGagal membuat kesimpulan. Silakan coba lagi. \n\n*Detail Teknis: ${e.message}*`);
            success = true; // Stop trying if it's not a rate limit error
        }
    }
    if (!success) {
        setAiSummary('Gagal membuat kesimpulan setelah beberapa percobaan (Batas Kecepatan).');
    }
    setIsSummaryLoading(false);
  };

  // New function to handle downloading an empty template
  const handleDownloadTemplate = async () => {
    try {
      await loadXlsxScript(); // Ensure XLSX library is loaded
      const wb = window.XLSX.utils.book_new();
      const headers = [
        'Kode EP',
        'Uraian Elemen Penilaian',
        'Rekomendasi Hasil Survey',
        'Rencana Perbaikan',
        'Indikator Pencapaian',
        'Sasaran',
        'Waktu Penyelesaian',
        'Penanggung Jawab',
        'Keterangan'
      ];
      
      const ws = window.XLSX.utils.aoa_to_sheet([headers]); // Create sheet with only headers
      window.XLSX.utils.book_append_sheet(wb, ws, "Template PPS");

      const xlsxData = window.XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
      const blob = new Blob([xlsxData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
      
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `Template PPS - ${new Date().toISOString().slice(0,10)}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
      setModalMessage({ message: "Template Excel berhasil diunduh!", type: 'info' }); // Success message
    } catch (e) {
      setModalMessage({ message: `Gagal mengunduh template: ${e.message}`, type: 'error' }); // Error message via modal
      console.error("Kesalahan pengunduhan template:", e);
    }
  };
  
  // Function to handle downloading all data
  const handleDownload = () => {
    if (!groupedData) { setModalMessage({ message: "Tidak ada data untuk diunduh.", type: 'info' }); return; }
    
    const flattenedData = [];
    // Headers for the "Data PPS" sheet
    const headers = ['BAB', 'STANDAR', 'KRITERIA', 'ELEMEN PENILAIAN', 'RENCANA PERBAIKAN', 'INDIKATOR', 'SASARAN', 'WAKTU', 'PJ', 'KETERANGAN'];
    Object.values(groupedData).forEach(bab => {
        Object.values(bab.standards).forEach(standard => {
            Object.values(standard.criterias).forEach(criteria => {
                criteria.items.forEach(item => {
                    const [babNum, stdNum, kriNum, ...epParts] = item.kode_ep.split('.');
                    const epNum = epParts.join('.');
                    flattenedData.push({ 'BAB': babNum, 'STANDAR': stdNum, 'KRITERIA': kriNum, 'ELEMEN PENILAIAN': epNum, 'RENCANA PERBAIKAN': item.rencana_perbaikan, 'INDIKATOR': item.indikator, 'SASARAN': item.sasaran, 'WAKTU': item.waktu, 'PJ': item.pj, 'KETERANGAN': item.keterangan });
                });
            });
        });
    });

    const triggerDownload = (blob, filename) => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
    };
    const outputFilename = `Hasil PPS - ${new Date().toISOString().slice(0,10)}`;

    if (downloadFormat === 'xlsx') {
        const wb = window.XLSX.utils.book_new();
        const wsData = window.XLSX.utils.json_to_sheet(flattenedData);
        window.XLSX.utils.book_append_sheet(wb, wsData, "Data PPS");
        
        // Add Document Inventory sheet
        const docInventoryData = prepareDocumentInventoryData();
        if (docInventoryData.length > 0) {
            const wsDocInventory = window.XLSX.utils.json_to_sheet(docInventoryData);
            window.XLSX.utils.book_append_sheet(wb, wsDocInventory, "Inventaris Dokumen");
        }

        // Add Documents Grouped by Type sheet
        const groupedDocDataForExcel = prepareGroupedDocumentDataForExcel(); // Use the new function for Excel
        if (groupedDocDataForExcel.length > 0) {
            const groupedDocHeaders = ['Tipe Dokumen', 'Judul Dokumen', 'Kode EP Terkait', 'Uraian EP Terkait', 'Rencana Perbaikan', 'Indikator', 'Sasaran', 'Waktu', 'PJ'];
            const wsGroupedDocs = window.XLSX.utils.json_to_sheet(groupedDocDataForExcel, { header: groupedDocHeaders });
            window.XLSX.utils.book_append_sheet(wb, wsGroupedDocs, "Pengelompokan Dokumen");
        }

        if (aiSummary) {
            // Remove markdown formatting for the Excel sheet
            const summaryText = aiSummary.replace(/\*\*(.*?)\*\*/g, '$1'); 
            const summaryRows = summaryText.split('\n').map(line => [line]);
            const wsSummary = window.XLSX.utils.aoa_to_sheet(summaryRows);
            wsSummary['!cols'] = [{ wch: 100 }]; // Set column width for summary
            window.XLSX.utils.book_append_sheet(wb, wsSummary, "Kesimpulan AI");
        }
        const xlsxData = window.XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
        const blob = new Blob([xlsxData], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        triggerDownload(blob, `${outputFilename}.xlsx`);
        setModalMessage({ message: "File Excel berhasil diunduh!", type: 'info' });
    } else { 
        let content;
        let fileExtension;
        let mimeType;

        if (downloadFormat === 'csv' || downloadFormat === 'txt') {
            const delimiter = downloadFormat === 'csv' ? ',' : '\t';
            content = headers.join(delimiter) + '\n';
            flattenedData.forEach(row => {
                const values = headers.map(header => {
                    let cell = row[header] ? String(row[header]) : '';
                    cell = cell.replace(/"/g, '""');
                    if (cell.includes(delimiter) || cell.includes('"') || cell.includes('\n')) { cell = `"${cell}"`; }
                    return cell;
                });
                content += values.join(delimiter) + '\n';
            });
            
            // Add document inventory to text/csv output
            const docInventoryData = prepareDocumentInventoryData();
            if (docInventoryData.length > 0) {
              content += `\n\n\nINVENTARIS DOKUMEN\n\n`;
              content += Object.keys(docInventoryData[0]).join(delimiter) + '\n';
              docInventoryData.forEach(row => {
                const values = Object.values(row).map(value => {
                  let cell = value ? String(value) : '';
                  cell = cell.replace(/"/g, '""');
                  if (cell.includes(delimiter) || cell.includes('"') || cell.includes('\n')) { cell = `"${cell}"`; }
                  return cell;
                });
                content += values.join(delimiter) + '\n';
              });
            }

            // Add documents grouped by type to text/csv output
            const groupedDocDataForExcel = prepareGroupedDocumentDataForExcel(); // Use Excel prep function
            if (groupedDocDataForExcel.length > 0) {
                content += `\n\n\nPENGELOMPOKAN DOKUMEN BERDASARKAN TIPE\n\n`;
                const groupedDocHeaders = ['Tipe Dokumen', 'Judul Dokumen', 'Kode EP Terkait', 'Uraian EP Terkait', 'Rencana Perbaikan', 'Indikator', 'Sasaran', 'Waktu', 'PJ'];
                content += groupedDocHeaders.join(delimiter) + '\n';
                groupedDocDataForExcel.forEach(docItem => {
                    const values = groupedDocHeaders.map(header => {
                      let cell = docItem[header] ? String(docItem[header]) : '';
                      cell = cell.replace(/"/g, '""');
                      if (cell.includes(delimiter) || cell.includes('"') || cell.includes('\n')) { cell = `"${cell}"`; }
                      return cell;
                    });
                    content += values.join(delimiter) + '\n';
                });
            }

            if (aiSummary) {
                // Remove markdown formatting for CSV/TXT
                content += `\n\n\nKESIMPULAN & SARAN STRATEGIS AI\n\n${aiSummary.replace(/\*\*/g, '')}`;
            }
            fileExtension = downloadFormat;
            mimeType = `text/${downloadFormat};charset=utf-8;`;
            const blob = new Blob([content], { type: mimeType });
            triggerDownload(blob, `${outputFilename}.${fileExtension}`);
            setModalMessage({ message: `File ${downloadFormat.toUpperCase()} berhasil diunduh!`, type: 'info' });
        } else if (downloadFormat === 'docx') {
            content = `<!DOCTYPE html><html><head><meta charset='UTF-8'><title>Hasil PPS</title><style>table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; } h1, h2 { font-family: sans-serif; }</style></head><body><h1>Data Perencanaan Perbaikan Strategis</h1><table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            flattenedData.forEach(row => {
                content += '<tr>';
                headers.forEach(h => { content += `<td>${row[h] || ''}</td>`; });
                content += '</tr>';
            });
            content += '</tbody></table>';

            // Add Document Inventory to DOCX output
            const docInventoryData = prepareDocumentInventoryData();
            if (docInventoryData.length > 0) {
              content += `<h2>Inventaris Dokumen</h2><table><thead><tr>${Object.keys(docInventoryData[0]).map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
              docInventoryData.forEach(row => {
                const values = Object.values(row).map(value => {
                  return value || ''; // Ensure non-null value for display
                });
                content += '<tr>';
                values.forEach(value => { content += `<td>${value}</td>`; });
                content += '</tr>';
              });
              content += '</tbody></table>';
            }

            // Add Documents Grouped by Type to DOCX output
            const groupedDocDataForExcel = prepareGroupedDocumentDataForExcel(); // Use Excel prep function
            if (groupedDocDataForExcel.length > 0) {
                content += `<h2>Pengelompokan Dokumen Berdasarkan Tipe</h2>`;
                const groupedDocHeaders = ['Tipe Dokumen', 'Judul Dokumen', 'Kode EP Terkait', 'Uraian EP Terkait', 'Rencana Perbaikan', 'Indikator', 'Sasaran', 'Waktu', 'PJ'];
                content += `<table><thead><tr>${groupedDocHeaders.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
                groupedDocDataForExcel.forEach(docItem => {
                    content += '<tr>';
                    groupedDocHeaders.forEach(header => {
                      content += `<td>${docItem[header] || ''}</td>`;
                    });
                    content += '</tr>';
                });
                content += '</tbody></table>';
            }


            if (aiSummary) {
                // Retain some basic HTML formatting for DOCX
                content += `<h2>Kesimpulan & Saran Strategis AI</h2><div>${aiSummary.replace(/\n/g, '<br/>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</div>`;
            }
            content += '</body></html>';
            fileExtension = 'doc';
            mimeType = 'application/vnd.ms-word';
            const blob = new Blob([content], { type: mimeType });
            triggerDownload(blob, `${outputFilename}.${fileExtension}`);
            setModalMessage({ message: "File Word (.doc) berhasil diunduh!", type: 'info' });
        }
    }
  };


  return (
    <div className="bg-slate-900 min-h-screen text-white font-sans p-4 sm:p-6 lg:p-8">
        {/* Lock Screen Overlay */}
        {isLocked && (
            <div className="fixed inset-0 bg-slate-900/90 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
                <form onSubmit={handlePasswordSubmit} className="w-full max-w-sm bg-slate-800 rounded-xl shadow-2xl p-8 border border-slate-700 text-center animate-fade-in">
                    <LockKeyhole className="w-16 h-16 text-cyan-400 mx-auto mb-4" />
                    <h2 className="text-2xl font-bold text-white mb-2">Aplikasi Terkunci</h2>
                    <p className="text-slate-400 mb-6">Silakan masukkan kata sandi untuk melanjutkan.</p>
                    <input 
                        type="password"
                        value={passwordInput}
                        onChange={(e) => setPasswordInput(e.target.value)}
                        placeholder="Kata Sandi"
                        className={`w-full bg-slate-700 border rounded-md px-4 py-3 text-white placeholder-slate-400 focus:outline-none focus:ring-2 text-center ${loginError ? 'border-red-500 focus:ring-red-500' : 'border-slate-600 focus:ring-cyan-500'}`}
                    />
                    {loginError && (
                        <p className="text-red-400 text-sm mt-3 flex items-center justify-center gap-2">
                            <AlertTriangle className="w-4 h-4" />
                            {loginError}
                        </p>
                    )}
                    <button type="submit" className="w-full mt-6 inline-flex items-center justify-center gap-2 px-6 py-3 bg-cyan-600 text-white font-semibold rounded-md hover:bg-cyan-500 transition-all duration-200 transform hover:scale-105 disabled:bg-slate-600">
                        <Unlock className="w-5 h-5" />
                        <span>Buka</span>
                    </button>
                </form>
            </div>
        )}

        {/* Message Modal for error/info */}
        <MessageModal 
          message={modalMessage.message} 
          type={modalMessage.type} 
          onClose={() => setModalMessage({ message: '', type: '' })} 
        />

        {/* Modal to display batch generate results */}
        {batchResult && (
          <MessageModal
            message={`Proses 'Buat Semua ${batchResult.field}' selesai:\nBerhasil: ${batchResult.success}\nGagal: ${batchResult.failed}`}
            type={batchResult.failed > 0 ? 'error' : 'info'}
            onClose={() => setBatchResult(null)}
          />
        )}

        {/* Global loading/progress indicator */}
        {(generationProgress.total > 0 || !isAuthReady || isProcessingFile) && ( // Add isProcessingFile to global loading condition
         <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center z-50">
           <LoaderCircle className="w-16 h-16 text-cyan-500 mb-4 animate-spin" />
           {!isAuthReady ? (
             <p className="text-white text-xl mt-4">Memuat aplikasi dan otentikasi Firebase...</p>
           ) : isProcessingFile ? (
             <p className="text-white text-xl mt-4">Memproses file Excel...</p>
           ) : (
             <>
               <p className="text-white text-xl mt-4">{generationProgress.message}</p>
               <p className="text-slate-400 mt-2">Memproses {generationProgress.current} dari {generationProgress.total}</p>
               <div className="w-1/2 bg-slate-700 rounded-full h-2.5 mt-4">
                 <div className="bg-cyan-500 h-2.5 rounded-full" style={{ width: `${(generationProgress.current / generationProgress.total) * 100}%` }}></div>
               </div>
             </>
           )}
         </div>
       )}
      <div className="max-w-7xl mx-auto">
        <header className="text-center mb-8 flex justify-between items-center">
            <div className="text-left">
                <h1 className="text-3xl sm:text-4xl font-bold text-cyan-400">Rencana Perbaikan Akreditasi Berbasis AI</h1>
                <p className="text-slate-400 mt-2">Unggah file Excel, AI akan membantu mengisi RTL, Indikator, Sasaran, dan Bukti Implementasi, lalu unduh hasilnya.</p>
            </div>
            <button onClick={handleLockApp} className="flex-shrink-0 ml-4 inline-flex items-center justify-center gap-2 px-4 py-2 bg-red-600 text-white font-semibold rounded-md hover:bg-red-500 transition-colors" title="Kunci Aplikasi">
                <Lock className="w-5 h-5" />
                <span className="hidden sm:inline">Kunci</span>
            </button>
        </header>
        
        <div className="bg-slate-800 rounded-xl p-6 mb-8 shadow-lg">
            <label htmlFor="apiKey" className="block text-sm font-medium text-slate-300 mb-2">Kunci API Google AI</label>
            <input 
                id="apiKey" 
                type="password" 
                value={apiKey} 
                onChange={(e) => { setApiKey(e.target.value); setIsApiKeyInvalid(false); }} 
                placeholder="Masukkan Kunci API Anda di sini..." 
                className={`w-full bg-slate-700 border rounded-md px-3 py-2 text-white placeholder-slate-400 focus:outline-none focus:ring-2 ${isApiKeyInvalid ? 'border-red-500 focus:ring-red-500' : 'border-slate-600 focus:ring-cyan-500'}`} 
            />
            <p className="text-xs text-slate-500 mt-2">Kunci API Anda tidak disimpan. Hanya digunakan untuk sesi ini.</p>
            {isApiKeyInvalid && (
                <p className="text-sm text-red-400 mt-2 flex items-center">
                    <AlertTriangle className="w-4 h-4 mr-1"/> Kunci API tidak valid atau belum dimasukkan. Harap periksa dan coba lagi.
                </p>
            )}
            <div className="mt-4">
                <button onClick={() => setOpenStates(prev => ({...prev, isHelpOpen: !prev.isHelpOpen}))} className="text-sm font-medium text-cyan-400 cursor-pointer hover:text-cyan-300 list-none flex items-center gap-1">
                    Bagaimana cara mendapatkan Kunci API?
                    <ChevronRight className={`w-4 h-4 transition-transform duration-200 ${openStates.isHelpOpen ? 'rotate-90' : ''}`} />
                </button>
                {openStates.isHelpOpen && (
                    <div className="mt-2 text-sm text-slate-400 bg-slate-900/50 p-4 rounded-md border border-slate-700">
                        <ol className="list-decimal list-inside space-y-2">
                            <li>Buka situs <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-teal-400 hover:underline">Google AI Studio</a>.</li>
                            <li>Masuk dengan akun Google Anda.</li>
                            <li>Klik tombol <span className="font-semibold text-slate-300">"Buat kunci API"</span>.</li>
                            <li>Salin (copy) kunci API yang baru dibuat.</li>
                            <li>Tempel (paste) kunci API tersebut ke kolom di atas.</li>
                        </ol>
                    </div>
                )}
            </div>
        </div>

        {!rawData && !groupedData && (
            <div className="flex flex-col items-center justify-center gap-4">
                <div {...getRootProps()} className={`w-full p-10 border-2 border-dashed rounded-xl transition-all duration-300 ${isProcessingFile ? 'cursor-wait bg-slate-800' : 'cursor-pointer hover:border-cyan-500 hover:bg-slate-800'} ${isDragActive ? 'border-cyan-400 bg-slate-700' : 'border-slate-600'}`}>
                    <input {...getInputProps()} />
                    <div className="flex flex-col items-center justify-center text-center">
                        {isProcessingFile ? (
                            <>
                                <LoaderCircle className="w-12 h-12 text-cyan-500 mb-4 animate-spin" />
                                <p className="text-lg font-semibold text-slate-300">Memproses file...</p>
                            </>
                        ) : (
                            <>
                                <UploadCloud className="w-12 h-12 text-slate-500 mb-4" />
                                {isDragActive ?
                                    <p className="text-lg font-semibold text-cyan-400">Lepaskan file di sini...</p> :
                                    <><p className="text-lg font-semibold text-slate-300">Seret & lepas file .xlsx atau .csv di sini</p><p className="text-sm text-slate-400 mt-1">Pastikan ada 1 kolom kode hierarki (misal: "Kode EP")</p></>
                                }
                            </>
                        )}
                    </div>
                </div>
                <button onClick={handleDownloadTemplate} className="inline-flex items-center justify-center gap-2 px-6 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-500 transition-all duration-200 transform hover:scale-105">
                    <Download className="w-5 h-5" /> <span>Unduh Template Excel</span>
                </button>
            </div>
        )}
        {/* Fix display condition: if rawData exists BUT groupedData does NOT yet, it's ready to be processed into a hierarchy. */}
        {rawData && !groupedData && ( 
          <div className="bg-slate-800 rounded-xl p-8 text-center shadow-lg animate-fade-in"> 
            <CheckCircle className="w-16 h-16 text-green-400 mx-auto mb-4" /> 
            <h2 className="text-2xl font-bold text-white">File Berhasil Dibaca!</h2> 
            <div className="inline-flex items-center bg-slate-700/50 text-slate-300 rounded-full px-4 py-2 my-4"> 
              <FileText className="w-5 h-5 mr-2 text-cyan-400" /> 
              <span className="font-medium">{fileName}</span> 
            </div> 
            <p className="text-slate-400 mb-6">File Anda siap diproses. Hierarki akan ditampilkan secara otomatis setelah data dimuat.</p> 
            <button 
              className="inline-flex items-center justify-center gap-2 px-6 py-3 bg-cyan-600 text-white font-semibold rounded-md hover:bg-cyan-500 transition-all duration-200" 
              disabled={true} // Disable button as process is automatic
            > 
              Memuat Data... <LoaderCircle className="w-5 h-5 animate-spin" /> 
            </button> 
          </div> 
        )}
        {error && (<div className="mt-4 bg-red-900/50 border border-red-700 text-red-300 px-4 py-3 rounded-lg flex items-center"><AlertTriangle className="w-5 h-5 mr-3"/><span>{error}</span></div>)}
        
        {groupedData && ( // Display this section only if groupedData exists
          <div className="animate-fade-in">
             <div className="my-6 p-4 bg-slate-800/50 rounded-lg flex flex-col sm:flex-row flex-wrap gap-4 justify-between items-center">
                <h3 className="text-lg font-bold text-white w-full sm:w-auto text-center sm:text-left">Panel Aksi Cepat (AI)</h3>
                {/* Button Generate All RTL */}
                <button onClick={handleGenerateAllRTL} disabled={generationProgress.total > 0 || !apiKey || isApiKeyInvalid} className="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-yellow-600 text-white font-semibold rounded-md hover:bg-yellow-500 disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors">
                    <Zap className="w-5 h-5" />
                    <span>Buat Semua RTL</span>
                </button>
                {/* Button Generate All Indikator */}
                <button onClick={handleGenerateAllIndikator} disabled={generationProgress.total > 0 || !apiKey || isApiKeyInvalid} className="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white font-semibold rounded-md hover:bg-green-500 disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors">
                    <Zap className="w-5 h-5" />
                    <span>Buat Semua Indikator</span>
                </button>
                {/* Button Generate All Sasaran */}
                <button onClick={handleGenerateAllSasaran} disabled={generationProgress.total > 0 || !apiKey || isApiKeyInvalid} className="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-500 disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors">
                    <Zap className="w-5 h-5" />
                    <span>Buat Semua Sasaran</span>
                </button>
                {/* Button Generate All Keterangan */}
                <button onClick={handleGenerateAllKeterangan} disabled={generationProgress.total > 0 || !apiKey || isApiKeyInvalid} className="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-4 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-500 disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors">
                    <Zap className="w-5 h-5" />
                    <span>Buat Semua Keterangan</span>
                </button>
            </div>
            {/* New buttons to toggle visibility of document sections */}
            <div className="my-4 flex flex-col sm:flex-row justify-center gap-4">
                <button
                    onClick={() => setShowDocumentInventory(prev => !prev)}
                    className="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2 bg-slate-700 text-white font-semibold rounded-md hover:bg-slate-600 transition-colors"
                >
                    {showDocumentInventory ? 'Sembunyikan' : 'Tampilkan'} Inventaris Dokumen
                    <ChevronRight className={`w-4 h-4 transition-transform duration-200 ${showDocumentInventory ? 'rotate-90' : ''}`} />
                </button>
                <button
                    onClick={() => setShowDocumentGrouping(prev => !prev)}
                    className="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2 bg-slate-700 text-white font-semibold rounded-md hover:bg-slate-600 transition-colors"
                >
                    {showDocumentGrouping ? 'Sembunyikan' : 'Tampilkan'} Pengelompokan Dokumen
                    <ChevronRight className={`w-4 h-4 transition-transform duration-200 ${showDocumentGrouping ? 'rotate-90' : ''}`} />
                </button>
            </div>


            <div className="space-y-2 mt-8">
              {Object.values(groupedData).map(bab => (
                  <div key={bab.title} className="bg-slate-800 rounded-lg shadow-md overflow-hidden">
                      <div onClick={() => toggleOpen(bab.title)} className="flex justify-between items-center bg-slate-700/50 px-6 py-3 cursor-pointer hover:bg-slate-700">
                          <h2 className="text-xl font-bold text-cyan-400">{bab.title}</h2>
                          <ChevronRight className={`w-6 h-6 text-cyan-400 transition-transform duration-300 ${openStates[bab.title] ? 'rotate-90' : ''}`} />
                      </div>
                      {openStates[bab.title] && (
                          <div className="p-4 space-y-3">
                          {Object.values(bab.standards).map(standard => {
                              const standardId = `${bab.title}-${standard.title}`;
                              return (
                                  <div key={standardId} className="bg-slate-900/70 rounded-md">
                                      <div onClick={() => toggleOpen(standardId)} className="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-slate-800/80 border-b border-slate-700">
                                          <h3 className="text-lg font-semibold text-teal-300">{standard.title}</h3>
                                          <ChevronRight className={`w-5 h-5 text-teal-300 transition-transform duration-300 ${openStates[standardId] ? 'rotate-90' : ''}`} />
                                      </div>
                                      {openStates[standardId] && (
                                          <div className="p-3 space-y-2">
                                            {Object.values(standard.criterias).map(criteria => {
                                                const criteriaId = `${standardId}-${criteria.title}`;
                                                return (
                                                    <div key={criteriaId} className="bg-slate-800/60 rounded">
                                                        <div onClick={() => toggleOpen(criteriaId)} className="flex justify-between items-center px-4 py-2 cursor-pointer hover:bg-slate-700/70 border-b border-slate-700/50">
                                                            <h4 className="font-semibold text-amber-300">{criteria.title}</h4>
                                                            <ChevronRight className={`w-5 h-5 text-amber-300 transition-transform duration-300 ${openStates[criteriaId] ? 'rotate-90' : ''}`} />
                                                        </div>
                                                        {openStates[criteriaId] && (
                                                            <div className="p-4 space-y-4">
                                                              {criteria.items.map(item => (
                                                                  <div key={item.id} className="bg-slate-700/50 p-4 rounded-lg border border-slate-600">
                                                                      <p className="font-bold text-cyan-500 mb-2">{item.kode_ep}</p>
                                                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-y-3 gap-x-6 text-sm">
                                                                          {/* Rencana Perbaikan */}
                                                                          <div className="flex items-start gap-2">
                                                                            <strong className="text-slate-400 whitespace-nowrap">Rencana Perbaikan:</strong> 
                                                                            <div className="flex-grow">
                                                                              <p>{item.rencana_perbaikan}</p>
                                                                              <button onClick={() => handleGenerateRTL(item)} disabled={loadingStates[item.id + '_rtl'] || !apiKey || isApiKeyInvalid} className="mt-1 flex items-center gap-1 text-xs text-yellow-400 hover:text-yellow-300 disabled:text-slate-500 disabled:cursor-not-allowed">
                                                                                {loadingStates[item.id + '_rtl'] ? <><LoaderCircle className="w-3 h-3 animate-spin"/> Memproses...</> : <><Lightbulb className="w-3 h-3"/> Buat/Perbaiki dengan AI</>}
                                                                              </button>
                                                                            </div>
                                                                          </div>
                                                                          {/* Indikator */}
                                                                          <div className="flex items-start gap-2">
                                                                            <strong className="text-slate-400 whitespace-nowrap">Indikator:</strong> 
                                                                            <div className="flex-grow">
                                                                              <p>{item.indikator}</p>
                                                                              <button onClick={() => handleGenerateIndikator(item)} disabled={loadingStates[item.id + '_indikator'] || !apiKey || isApiKeyInvalid} className="mt-1 flex items-center gap-1 text-xs text-green-400 hover:text-green-300 disabled:text-slate-500 disabled:cursor-not-allowed">
                                                                                {loadingStates[item.id + '_indikator'] ? <><LoaderCircle className="w-3 h-3 animate-spin"/> Memproses...</> : <><Lightbulb className="w-3 h-3"/> Buat/Perbaiki dengan AI</>}
                                                                              </button>
                                                                            </div>
                                                                          </div>
                                                                          {/* Sasaran */}
                                                                          <div className="flex items-start gap-2">
                                                                            <strong className="text-slate-400 whitespace-nowrap">Sasaran:</strong> 
                                                                            <div className="flex-grow">
                                                                              <p>{item.sasaran}</p>
                                                                              <button onClick={() => handleGenerateSasaran(item)} disabled={loadingStates[item.id + '_sasaran'] || !apiKey || isApiKeyInvalid} className="mt-1 flex items-center gap-1 text-xs text-blue-400 hover:text-blue-300 disabled:text-slate-500 disabled:cursor-not-allowed">
                                                                                {loadingStates[item.id + '_sasaran'] ? <><LoaderCircle className="w-3 h-3 animate-spin"/> Memproses...</> : <><Lightbulb className="w-3 h-3"/> Buat/Perbaiki dengan AI</>}
                                                                              </button>
                                                                            </div>
                                                                          </div>
                                                                          <div><strong className="text-slate-400">Waktu:</strong> {item.waktu}</div>
                                                                          <div><strong className="text-slate-400">PJ:</strong> {item.pj}</div>
                                                                      </div>
                                                                      <div className="mt-4 pt-4 border-t border-slate-600">
                                                                          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                                                                              <div><strong className="text-slate-300 flex items-center gap-2 mb-1"><FileText size={16} /> Keterangan / Bukti Implementasi:</strong><p className="text-cyan-300 pl-2">{item.keterangan}</p></div>
                                                                              <button onClick={() => handleGenerateKeterangan(item)} disabled={loadingStates[item.id + '_ket'] || !apiKey || isApiKeyInvalid} className="flex-shrink-0 flex items-center justify-center gap-2 px-4 py-2 bg-cyan-600 text-white font-semibold rounded-md hover:bg-cyan-500 disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors duration-200">
                                                                                  {loadingStates[item.id + '_ket'] ? <LoaderCircle className="animate-spin w-5 h-5" /> : <BrainCircuit className="w-5 h-5" />}
                                                                                  <span>{loadingStates[item.id + '_ket'] ? 'Memproses...' : 'Buat Keterangan'}</span>
                                                                              </button>
                                                                          </div>
                                                                      </div>
                                                                  </div>
                                                              ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                          </div>
                                      )}
                                  </div>
                              );
                          })}
                          </div>
                      )}
                  </div>
              ))}
            </div>
            
            {/* Document Inventory Section (Now toggled by button) */}
            {showDocumentInventory && (
              <div className="mt-8 p-6 bg-slate-800/70 rounded-xl shadow-lg border border-slate-700 animate-fade-in">
                <h3 className="text-xl font-bold text-cyan-400 mb-4">Inventaris Dokumen (Daftar Global)</h3>
                <p className="text-slate-400 mb-4">Daftar unik dokumen yang teridentifikasi beserta elemen penilaian terkait:</p>
                {documentInventory && documentInventory.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="min-w-full bg-slate-700/50 rounded-lg overflow-hidden">
                      <thead>
                        <tr className="bg-slate-600/70 text-slate-200 uppercase text-sm leading-normal">
                          <th className="py-3 px-6 text-left">Judul Dokumen (Keterangan)</th>
                          <th className="py-3 px-6 text-left">Kode Elemen Penilaian Terkait</th>
                          <th className="py-3 px-6 text-left">Uraian Elemen Penilaian Terkait</th>
                        </tr>
                      </thead>
                      <tbody className="text-slate-300 text-sm font-light">
                        {documentInventory.map((doc, index) => (
                          <tr key={index} className="border-b border-slate-600 hover:bg-slate-700/60">
                            <td className="py-3 px-6 text-left whitespace-normal break-words w-1/3">{doc['Judul Dokumen (Keterangan)']}</td>
                            <td className="py-3 px-6 text-left whitespace-normal break-words w-1/4">{doc['Kode Elemen Penilaian Terkait']}</td>
                            <td className="py-3 px-6 text-left whitespace-normal break-words w-auto">{doc['Uraian Elemen Penilaian Terkait']}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <p className="text-slate-500 italic">Tidak ada dokumen yang ditemukan untuk inventarisasi. Pastikan kolom 'Keterangan' sudah terisi dengan data yang valid.</p>
                )}
              </div>
            )}

            {/* Documents Grouped by Type Section (Now toggled by button) */}
            {showDocumentGrouping && (
              <div className="mt-8 p-6 bg-slate-800/70 rounded-xl shadow-lg border border-slate-700 animate-fade-in">
                <h3 className="text-xl font-bold text-cyan-400 mb-4">Pengelompokan Dokumen Berdasarkan Tipe</h3>
                <p className="text-slate-400 mb-4">Dokumen yang teridentifikasi, dikelompokkan berdasarkan tipenya:</p>
                {groupedDocumentsByTypeForDisplay && Object.keys(groupedDocumentsByTypeForDisplay).length > 0 ? (
                  <div className="space-y-4">
                    {Object.keys(groupedDocumentsByTypeForDisplay).sort().map(type => (
                      <div key={type} className="bg-slate-900/70 rounded-md overflow-hidden">
                        <div onClick={() => toggleOpen(`docType-${type}`)} className="flex justify-between items-center px-5 py-3 cursor-pointer hover:bg-slate-800/80 border-b border-slate-700">
                          <h4 className="text-lg font-semibold text-teal-300">{type} ({groupedDocumentsByTypeForDisplay[type].length} dokumen)</h4>
                          <ChevronRight className={`w-5 h-5 text-teal-300 transition-transform duration-300 ${openStates[`docType-${type}`] ? 'rotate-90' : ''}`} />
                        </div>
                        {openStates[`docType-${type}`] && (
                          <div className="p-3 overflow-x-auto">
                            <table className="min-w-full bg-slate-800/60 rounded-lg">
                              <thead>
                                <tr className="bg-slate-700/50 text-slate-200 uppercase text-xs leading-normal">
                                  <th className="py-2 px-4 text-left">Judul Dokumen</th>
                                  <th className="py-2 px-4 text-left">Kode EP Terkait</th>
                                  <th className="py-2 px-4 text-left">Uraian EP Terkait</th>
                                  <th className="py-2 px-4 text-left">Rencana Perbaikan</th>
                                  <th className="py-2 px-4 text-left">Indikator</th>
                                  <th className="py-2 px-4 text-left">Sasaran</th>
                                  <th className="py-2 px-4 text-left">Waktu</th>
                                  <th className="py-2 px-4 text-left">PJ</th>
                                </tr>
                              </thead>
                              <tbody className="text-slate-300 text-xs font-light">
                                {groupedDocumentsByTypeForDisplay[type].map((docItem, itemIndex) => (
                                  <tr key={itemIndex} className="border-b border-slate-700 hover:bg-slate-700/70">
                                    <td className="py-2 px-4 whitespace-normal break-words">{docItem['Judul Dokumen']}</td>
                                    <td className="py-2 px-4 whitespace-normal break-words">{docItem['Kode EP Terkait']}</td>
                                    <td className="py-2 px-4 whitespace-normal break-words">{docItem['Uraian EP Terkait']}</td>
                                    <td className="py-2 px-4 whitespace-normal break-words">{docItem['Rencana Perbaikan']}</td>
                                    <td className="py-2 px-4 whitespace-normal break-words">{docItem['Indikator']}</td>
                                    <td className="py-2 px-4 whitespace-normal break-words">{docItem['Sasaran']}</td>
                                    <td className="py-2 px-4 whitespace-normal break-words">{docItem['Waktu']}</td>
                                    <td className="py-2 px-4 whitespace-normal break-words">{docItem['PJ']}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="text-slate-500 italic">Tidak ada dokumen yang ditemukan untuk dikelompokkan. Pastikan kolom 'Keterangan' sudah terisi dengan data yang valid.</p>
                )}
              </div>
            )}

            <div className="mt-8 p-6 bg-slate-800/70 rounded-xl shadow-lg border border-slate-700">
              <h3 className="text-xl font-bold text-cyan-400 mb-4">Kesimpulan & Saran Strategis AI</h3>
              {!aiSummary && !isSummaryLoading && (
                <div className="text-center">
                    <p className="text-slate-400 mb-4">Klik tombol di bawah untuk meminta AI menganalisis seluruh data dan memberikan saran pengelompokan kegiatan.</p>
                    <button onClick={handleGenerateSummary} disabled={!apiKey || isApiKeyInvalid} className="inline-flex items-center justify-center gap-2 px-6 py-2 bg-purple-600 text-white font-semibold rounded-md hover:bg-purple-500 disabled:bg-slate-600 disabled:cursor-not-allowed transition-colors">
                        <BrainCircuit className="w-5 h-5" />
                        <span>Buat Kesimpulan & Saran AI</span>
                    </button>
                </div>
              )}
              {isSummaryLoading && (
                <div className="flex flex-col items-center justify-center text-center">
                    <LoaderCircle className="w-8 h-8 text-purple-400 animate-spin mb-3" />
                    <p className="text-slate-300">AI sedang menganalisis dan membuat kesimpulan...</p>
                </div>
              )}
              {aiSummary && (
                <div className="prose prose-invert max-w-none text-slate-300" dangerouslySetInnerHTML={{ __html: aiSummary.replace(/\n/g, '<br />').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') }} />
              )}
            </div>

            <div className="mt-8 p-6 bg-slate-800/70 rounded-xl shadow-lg border border-slate-700">
              <h3 className="text-xl font-bold text-cyan-400 mb-4">Unduh Hasil</h3>
              <p className="text-slate-400 mb-4">Pilih format file untuk mengunduh data yang telah diproses.</p>
              <div className="flex flex-col sm:flex-row items-center gap-4">
                  <select onChange={(e) => setDownloadFormat(e.target.value)} value={downloadFormat} className="w-full sm:w-auto bg-slate-700 border border-slate-600 rounded-md px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500">
                      <option value="xlsx">Excel (.xlsx)</option> <option value="csv">CSV (.csv)</option> <option value="txt">Teks (.txt)</option> <option value="docx">Word (.doc)</option>
                  </select>
                  <button onClick={handleDownload} className="w-full sm:w-auto inline-flex items-center justify-center gap-2 px-6 py-2 bg-teal-600 text-white font-semibold rounded-md hover:bg-teal-500 transition-colors duration-200">
                      <Download className="w-5 h-5" /> <span>Unduh File</span>
                  </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
